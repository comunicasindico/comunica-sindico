<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Admin ‚Äî Comunica S√≠ndico</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c1526;
      --line:rgba(255,255,255,.10);
      --muted:rgba(234,242,255,.72);
      --text:rgba(234,242,255,.96);
      --ok:#44d07a;
      --warn:#ffb347;
      --bad:#ff5a5a;
      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background: radial-gradient(1200px 700px at 20% 0%, #122b52 0%, var(--bg) 55%); color:var(--text); font-family:var(--sans); }
    a{ color:inherit; }
    .wrap{ min-height:100%; padding:16px; display:flex; justify-content:center; }
    .app{ width:min(1200px, 100%); display:grid; grid-template-columns: 390px 1fr; gap:14px; align-items:start; }
    @media (max-width: 980px){ .app{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(18,35,60,.92), rgba(12,22,40,.92));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.14);
    }
    .title{ font-weight:900; letter-spacing:.5px; }
    .sub{ font-size:12px; color:var(--muted); font-weight:800; margin-top:2px; }
    .body{ padding:14px; display:flex; flex-direction:column; gap:12px; }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:12px; font-weight:900; letter-spacing:.25px; color:rgba(234,242,255,.88); }
    input, textarea, select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-weight:750;
    }
    textarea{ min-height:88px; resize:vertical; font-weight:650; line-height:1.25; }
    input::placeholder, textarea::placeholder{ color:rgba(234,242,255,.45); font-weight:650; }
    .mini{ font-size:12px; color:var(--muted); font-weight:800; line-height:1.25; }

    .btnRow{ display:flex; flex-wrap:wrap; gap:10px; }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      transition: transform .06s ease, filter .15s ease, opacity .15s ease;
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn:active{ transform:scale(.98); }
    .btn.ok{ background: rgba(68,208,122,.16); border-color: rgba(68,208,122,.40); }
    .btn.warn{ background: rgba(255,179,71,.14); border-color: rgba(255,179,71,.45); }
    .btn.bad{ background: rgba(255,90,90,.14); border-color: rgba(255,90,90,.55); }
    .btn.ghost{ background: transparent; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .pill{
      padding:6px 10px; border-radius:999px;
      font-weight:900; font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      white-space:nowrap;
    }

    .hr{ height:1px; background: rgba(255,255,255,.10); margin:4px 0; }

    /* Lista de v√≠deos */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .item .col{ flex:1; display:flex; flex-direction:column; gap:8px; }
    .item .actions{ display:flex; flex-direction:column; gap:8px; }
    .chip{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(234,242,255,.86);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius:14px;
      word-break:break-word;
    }

    /* Preview / JSON */
    .code{
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      background: rgba(0,0,0,.32);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      white-space:pre;
      overflow:auto;
      max-height: 55vh;
    }

    /* Preview alerta */
    .alertPreview{
      border-radius:18px;
      border:1px solid rgba(255,90,90,.60);
      background: linear-gradient(180deg, rgba(255,90,90,.22), rgba(80,0,0,.30));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), 0 18px 38px rgba(0,0,0,.45);
      padding:14px;
    }
    .alertPreview .aTitle{
      font-weight:1000;
      letter-spacing:.6px;
      text-transform:uppercase;
      font-size: clamp(18px, 2.1vw, 30px);
      color:#fff;
      margin:0 0 10px;
    }
    .alertPreview .aMsg{
      margin:0;
      font-weight:900;
      color:#fff;
      font-size: clamp(16px, 1.9vw, 28px);
      line-height:1.18;
      word-break:break-word;
    }

    .hint{
      font-size:12px;
      color:rgba(234,242,255,.70);
      font-weight:800;
      background: rgba(0,0,0,.20);
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 10px 12px;
      line-height: 1.3;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">

      <!-- ESQUERDA: Controles -->
      <div class="card">
        <div class="head">
          <div>
            <div class="title">Admin (Discreto)</div>
            <div class="sub">Edita e publica <b>data.json</b> no GitHub</div>
          </div>
          <div class="pill" id="statusPill">Offline</div>
        </div>

        <div class="body">

          <div class="hint">
            ‚úÖ Fluxo: <b>Carregar</b> ‚Üí ajustar campos ‚Üí <b>Publicar no GitHub</b>. <br/>
            üîí Token fica somente no seu navegador (sessionStorage).
          </div>

          <div class="field">
            <label>Token do GitHub (PAT com permiss√£o repo)</label>
            <input id="token" type="password" placeholder="ghp_..." />
            <div class="mini">Dica: cole aqui, clique em <b>Salvar token</b>, depois <b>Publicar</b>.</div>
            <div class="btnRow">
              <button class="btn ghost" id="btnSaveToken">üíæ Salvar token</button>
              <button class="btn ghost" id="btnClearToken">üßπ Limpar token</button>
              <button class="btn ghost" id="btnOpenPanel">üñ•Ô∏è Abrir Painel do S√≠ndico</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="btnRow">
            <button class="btn ok" id="btnLoad">‚ü≥ Carregar data.json</button>
            <button class="btn warn" id="btnDownload">‚¨áÔ∏è Baixar data.json</button>
            <button class="btn bad" id="btnPublish">üöÄ Publicar no GitHub</button>
          </div>

          <div class="hr"></div>

          <div class="field">
            <label>T√≠tulo</label>
            <input id="fTitulo" placeholder="Comunica S√≠ndico ‚Äî Cond√¥minos" />
          </div>

          <div class="field">
            <label>Subt√≠tulo</label>
            <input id="fSubtitulo" placeholder="Painel Informativo" />
          </div>

          <div class="field">
            <label>Refer√™ncia (rodap√©)</label>
            <input id="fReferencia" placeholder="Atualizado automaticamente" />
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field">
              <label>Rota√ß√£o: intervalo (seg)</label>
              <input id="fRotInterval" type="number" min="3" max="60" step="1" />
            </div>
            <div class="field">
              <label>Qtd avisos (por tela)</label>
              <select id="fRotQtd">
                <option value="3">3</option>
                <option value="4">4</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="field">
            <label>Cidade (Clima)</label>
            <input id="fCidade" placeholder="S√£o Paulo" />
            <div class="btnRow">
              <button class="btn ghost" id="btnBuscarCidade">üîé Buscar coordenadas</button>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Latitude</label>
              <input id="fLat" type="number" step="0.0001" />
            </div>
            <div class="field">
              <label>Longitude</label>
              <input id="fLon" type="number" step="0.0001" />
            </div>
          </div>

          <div class="field">
            <label>Timezone</label>
            <input id="fTz" placeholder="America/Sao_Paulo" />
          </div>

          <div class="hr"></div>

          <div class="field">
            <label>Cabe√ßalho ‚Äî Imagem da cidade</label>
            <div class="row">
              <select id="fCabAtivar">
                <option value="false">Desligada</option>
                <option value="true">Ligada</option>
              </select>
              <input id="fCabUrl" placeholder="https://..." />
            </div>
            <div class="mini">Se ligado, o painel do s√≠ndico usa essa URL para o cabe√ßalho (quando voc√™ implementar/ativar no painel).</div>
          </div>

          <div class="hr"></div>

          <div class="field">
            <label>ALERTA URGENTE</label>
            <div class="row">
              <select id="fAlertAtivar">
                <option value="false">Desligado (normal)</option>
                <option value="true">Ligado (substitui Mensagens no Brasil)</option>
              </select>
              <select id="fAlertPiscar">
                <option value="true">Piscar: Sim</option>
                <option value="false">Piscar: N√£o</option>
              </select>
            </div>
            <input id="fAlertTitulo" placeholder="ALERTA URGENTE" />
            <textarea id="fAlertMsg" placeholder="Escreva a mensagem do alerta..."></textarea>

            <div class="btnRow">
              <button class="btn bad" id="btnAlertOn">üö® Ligar alerta</button>
              <button class="btn ok" id="btnAlertOff">‚úÖ Desligar alerta</button>
            </div>

            <div class="mini">Para ‚Äúvoltar tudo ao normal‚Äù: clique em <b>Desligar alerta</b> e publique.</div>
          </div>

          <div class="hr"></div>

          <div class="field">
            <label>V√≠deos (Publicidades)</label>
            <div class="btnRow">
              <button class="btn ghost" id="btnAddVideo">‚ûï Incluir v√≠deo</button>
              <button class="btn ghost" id="btnShuffleToggle">üîÄ Alternar Shuffle</button>
            </div>
            <div class="mini">V√≠deos s√£o objetos em <b>publicidade.videos[]</b> (arquivo + anunciante).</div>
          </div>

          <div id="videosList" class="list"></div>

        </div>
      </div>

      <!-- DIREITA: Preview / JSON -->
      <div class="card">
        <div class="head">
          <div>
            <div class="title">Pr√©via & JSON</div>
            <div class="sub">Veja como ficar√° o alerta e o data.json final</div>
          </div>
          <div class="pill" id="pillRepo">comunicasindico/comunica-sindico</div>
        </div>

        <div class="body">
          <div class="btnRow">
            <button class="btn ghost" id="btnRebuild">üß© Regerar JSON</button>
            <button class="btn ghost" id="btnCopyJson">üìã Copiar JSON</button>
          </div>

          <div id="alertPreviewWrap" style="display:none">
            <div class="alertPreview" id="alertPreview">
              <p class="aTitle" id="pAlertTitle">ALERTA URGENTE</p>
              <p class="aMsg" id="pAlertMsg">‚Äî</p>
            </div>
          </div>

          <div class="code" id="jsonView">Carregue o data.json para come√ßar‚Ä¶</div>

        </div>
      </div>

    </div>
  </div>

<script>
/* ============================
   CONFIG DO REPO (AJUSTADO)
   ============================ */
const GITHUB_OWNER  = "comunicasindico";
const GITHUB_REPO   = "comunica-sindico";
const GITHUB_BRANCH = "main";
const GITHUB_PATH   = "data.json";

/* ============================
   ESTADO
   ============================ */
let DATA = null;         // objeto data.json
let DATA_ORIGINAL = null; // c√≥pia de refer√™ncia

const $ = (id)=>document.getElementById(id);
const statusPill = $("statusPill");

function setStatus(text, type){
  statusPill.textContent = text;
  statusPill.style.borderColor =
    type==="ok" ? "rgba(68,208,122,.55)" :
    type==="bad" ? "rgba(255,90,90,.65)" :
    "rgba(255,255,255,.12)";
  statusPill.style.background =
    type==="ok" ? "rgba(68,208,122,.16)" :
    type==="bad" ? "rgba(255,90,90,.14)" :
    "rgba(0,0,0,.18)";
  statusPill.style.color = type==="ok" ? "rgba(234,242,255,.96)" : "rgba(234,242,255,.85)";
}

function safeClone(obj){
  return JSON.parse(JSON.stringify(obj ?? null));
}

function prettyJson(obj){
  return JSON.stringify(obj, null, 2);
}

function getToken(){
  const v = ($("token").value || "").trim();
  if(v) return v;
  try{ return (sessionStorage.getItem("CS_GH_TOKEN")||"").trim(); }catch(e){ return ""; }
}

function saveToken(){
  const v = ($("token").value || "").trim();
  if(!v){ alert("Cole seu token primeiro."); return; }
  try{ sessionStorage.setItem("CS_GH_TOKEN", v); }catch(e){}
  $("token").value = "";
  alert("Token salvo neste navegador (sess√£o atual).");
}

function clearToken(){
  try{ sessionStorage.removeItem("CS_GH_TOKEN"); }catch(e){}
  $("token").value = "";
  alert("Token removido deste navegador.");
}

/* ============================
   LOAD data.json (mesma pasta)
   ============================ */
async function loadData(){
  setStatus("Carregando‚Ä¶","");

  try{
    const res = await fetch("./data.json?ts=" + Date.now(), { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const ct = (res.headers.get("content-type")||"").toLowerCase();
    if(!ct.includes("application/json")) throw new Error("Resposta n√£o-JSON: " + ct);

    const j = await res.json();
    DATA = j;
    DATA_ORIGINAL = safeClone(j);

    fillFormFromData();
    rebuildJsonView();

    setStatus("Atualizado","ok");
  }catch(e){
    console.error(e);
    setStatus("Offline","bad");
    alert("N√£o consegui carregar ./data.json. Confirme se admin.html est√° na mesma pasta do data.json.");
  }
}

/* ============================
   FORM <-> DATA
   ============================ */
function ensureBaseShape(){
  if(!DATA) DATA = {};
  DATA.condominio = DATA.condominio ?? "Comunica S√≠ndico";
  DATA.titulo = DATA.titulo ?? "Comunica S√≠ndico ‚Äî Cond√¥minos";
  DATA.subtitulo = DATA.subtitulo ?? "Painel Informativo";
  DATA.referencia = DATA.referencia ?? "Atualizado automaticamente";

  DATA.rotacao = DATA.rotacao ?? {};
  DATA.rotacao.ativar = (DATA.rotacao.ativar ?? true);
  DATA.rotacao.intervaloSeg = Number(DATA.rotacao.intervaloSeg ?? 8);
  DATA.rotacao.quantidadePorTela = Number(DATA.rotacao.quantidadePorTela ?? 3);
  DATA.rotacao.mostrarProgresso = (DATA.rotacao.mostrarProgresso ?? true);
  DATA.rotacao.pausarNoMouse = (DATA.rotacao.pausarNoMouse ?? false);

  DATA.clima = DATA.clima ?? {};
  DATA.clima.cidade = DATA.clima.cidade ?? "S√£o Paulo";
  DATA.clima.latitude = Number(DATA.clima.latitude ?? -23.5505);
  DATA.clima.longitude = Number(DATA.clima.longitude ?? -46.6333);
  DATA.clima.timezone = DATA.clima.timezone ?? "America/Sao_Paulo";

  DATA.publicidade = DATA.publicidade ?? {};
  DATA.publicidade.ativar = (DATA.publicidade.ativar ?? true);
  DATA.publicidade.shuffle = (DATA.publicidade.shuffle ?? true);
  DATA.publicidade.cidadeTitulo = DATA.publicidade.cidadeTitulo ?? "Mensagens no Brasil";

  DATA.publicidade.cabecalhoImagem = DATA.publicidade.cabecalhoImagem ?? { ativar:false, url:"" };
  DATA.publicidade.cabecalhoImagem.ativar = !!DATA.publicidade.cabecalhoImagem.ativar;
  DATA.publicidade.cabecalhoImagem.url = String(DATA.publicidade.cabecalhoImagem.url ?? "");

  DATA.publicidade.videos = Array.isArray(DATA.publicidade.videos) ? DATA.publicidade.videos : [];

  DATA.alertaUrgente = DATA.alertaUrgente ?? { ativar:false, titulo:"ALERTA URGENTE", mensagem:"", piscar:true };
  DATA.alertaUrgente.ativar = !!DATA.alertaUrgente.ativar;
  DATA.alertaUrgente.titulo = String(DATA.alertaUrgente.titulo ?? "ALERTA URGENTE");
  DATA.alertaUrgente.mensagem = String(DATA.alertaUrgente.mensagem ?? "");
  DATA.alertaUrgente.piscar = (DATA.alertaUrgente.piscar ?? true);
}

function fillFormFromData(){
  ensureBaseShape();

  $("fTitulo").value = DATA.titulo || "";
  $("fSubtitulo").value = DATA.subtitulo || "";
  $("fReferencia").value = DATA.referencia || "";

  $("fRotInterval").value = Number(DATA.rotacao.intervaloSeg || 8);
  $("fRotQtd").value = String(Number(DATA.rotacao.quantidadePorTela || 3));

  $("fCidade").value = DATA.clima.cidade || "";
  $("fLat").value = Number(DATA.clima.latitude || 0);
  $("fLon").value = Number(DATA.clima.longitude || 0);
  $("fTz").value = DATA.clima.timezone || "America/Sao_Paulo";

  $("fCabAtivar").value = String(!!DATA.publicidade.cabecalhoImagem.ativar);
  $("fCabUrl").value = DATA.publicidade.cabecalhoImagem.url || "";

  $("fAlertAtivar").value = String(!!DATA.alertaUrgente.ativar);
  $("fAlertPiscar").value = String(!!DATA.alertaUrgente.piscar);
  $("fAlertTitulo").value = DATA.alertaUrgente.titulo || "ALERTA URGENTE";
  $("fAlertMsg").value = DATA.alertaUrgente.mensagem || "";

  renderVideos();
  renderAlertPreview();
}

function applyFormToData(){
  ensureBaseShape();

  DATA.titulo = $("fTitulo").value.trim() || DATA.titulo;
  DATA.subtitulo = $("fSubtitulo").value.trim() || DATA.subtitulo;
  DATA.referencia = $("fReferencia").value.trim() || DATA.referencia;

  DATA.rotacao.intervaloSeg = Math.max(3, Math.min(60, Number($("fRotInterval").value || 8)));
  DATA.rotacao.quantidadePorTela = Number($("fRotQtd").value || 3);

  DATA.clima.cidade = $("fCidade").value.trim() || DATA.clima.cidade;
  DATA.clima.latitude = Number($("fLat").value || DATA.clima.latitude);
  DATA.clima.longitude = Number($("fLon").value || DATA.clima.longitude);
  DATA.clima.timezone = $("fTz").value.trim() || DATA.clima.timezone;

  DATA.publicidade.cabecalhoImagem.ativar = ($("fCabAtivar").value === "true");
  DATA.publicidade.cabecalhoImagem.url = $("fCabUrl").value.trim();

  DATA.alertaUrgente.ativar = ($("fAlertAtivar").value === "true");
  DATA.alertaUrgente.piscar = ($("fAlertPiscar").value === "true");
  DATA.alertaUrgente.titulo = $("fAlertTitulo").value.trim() || "ALERTA URGENTE";
  DATA.alertaUrgente.mensagem = $("fAlertMsg").value.trim();

  renderAlertPreview();
}

function rebuildJsonView(){
  if(!DATA){ $("jsonView").textContent = "Carregue o data.json para come√ßar‚Ä¶"; return; }
  applyFormToData();
  $("jsonView").textContent = prettyJson(DATA);
}

/* ============================
   ALERTA PREVIEW
   ============================ */
function renderAlertPreview(){
  if(!DATA) return;
  const on = !!DATA.alertaUrgente?.ativar;
  $("alertPreviewWrap").style.display = on ? "block" : "none";
  $("pAlertTitle").textContent = DATA.alertaUrgente?.titulo || "ALERTA URGENTE";
  $("pAlertMsg").textContent = DATA.alertaUrgente?.mensagem || "‚Äî";

  // piscar (opcional) no preview
  const blink = !!DATA.alertaUrgente?.piscar;
  $("alertPreview").style.animation = (on && blink) ? "blink 0.9s ease-in-out infinite" : "none";
}

(function injectBlink(){
  const st = document.createElement("style");
  st.textContent = `
    @keyframes blink{
      0%,100%{ filter:brightness(1); transform: translateY(0); }
      50%{ filter:brightness(1.18); transform: translateY(-1px); }
    }
  `;
  document.head.appendChild(st);
})();

/* ============================
   V√çDEOS CRUD
   ============================ */
function renderVideos(){
  ensureBaseShape();
  const list = $("videosList");
  list.innerHTML = "";

  if(!DATA.publicidade.videos.length){
    const d = document.createElement("div");
    d.className = "hint";
    d.innerHTML = "Nenhum v√≠deo cadastrado em <b>publicidade.videos</b>.";
    list.appendChild(d);
    return;
  }

  DATA.publicidade.videos.forEach((v, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "item";

    const col = document.createElement("div");
    col.className = "col";

    const inpFile = document.createElement("input");
    inpFile.placeholder = "./ads/seu_video.mp4";
    inpFile.value = String(v.arquivo || "");
    inpFile.oninput = ()=>{ v.arquivo = inpFile.value.trim(); rebuildJsonView(); };

    const inpAdv = document.createElement("input");
    inpAdv.placeholder = "Anunciante / texto";
    inpAdv.value = String(v.anunciante || "");
    inpAdv.oninput = ()=>{ v.anunciante = inpAdv.value.trim(); rebuildJsonView(); };

    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = `#${idx+1}  arquivo: ${String(v.arquivo||"‚Äî")}`;

    col.appendChild(chip);
    col.appendChild(inpFile);
    col.appendChild(inpAdv);

    const actions = document.createElement("div");
    actions.className = "actions";

    const up = document.createElement("button");
    up.className = "btn ghost";
    up.textContent = "‚¨ÜÔ∏è";
    up.title = "Subir";
    up.onclick = ()=>{
      if(idx<=0) return;
      const a = DATA.publicidade.videos;
      [a[idx-1], a[idx]] = [a[idx], a[idx-1]];
      renderVideos();
      rebuildJsonView();
    };

    const down = document.createElement("button");
    down.className = "btn ghost";
    down.textContent = "‚¨áÔ∏è";
    down.title = "Descer";
    down.onclick = ()=>{
      const a = DATA.publicidade.videos;
      if(idx>=a.length-1) return;
      [a[idx+1], a[idx]] = [a[idx], a[idx+1]];
      renderVideos();
      rebuildJsonView();
    };

    const del = document.createElement("button");
    del.className = "btn bad";
    del.textContent = "üóëÔ∏è";
    del.title = "Excluir";
    del.onclick = ()=>{
      if(!confirm("Excluir este v√≠deo?")) return;
      DATA.publicidade.videos.splice(idx,1);
      renderVideos();
      rebuildJsonView();
    };

    actions.appendChild(up);
    actions.appendChild(down);
    actions.appendChild(del);

    wrap.appendChild(col);
    wrap.appendChild(actions);
    list.appendChild(wrap);
  });
}

function addVideo(){
  ensureBaseShape();
  DATA.publicidade.videos.push({ arquivo:"./ads/novo.mp4", anunciante:"Novo v√≠deo" });
  renderVideos();
  rebuildJsonView();
}

function toggleShuffle(){
  ensureBaseShape();
  DATA.publicidade.shuffle = !DATA.publicidade.shuffle;
  alert("Shuffle agora est√°: " + (DATA.publicidade.shuffle ? "LIGADO" : "DESLIGADO"));
  rebuildJsonView();
}

/* ============================
   BUSCA CIDADE (OPEN-METEO GEO)
   ============================ */
async function buscarCidade(){
  const name = ($("fCidade").value||"").trim();
  if(!name){ alert("Digite o nome da cidade."); return; }

  try{
    setStatus("Buscando cidade‚Ä¶","");
    const url = "https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(name) + "&count=5&language=pt&format=json";
    const res = await fetch(url, { cache:"no-store" });
    const j = await res.json();
    const arr = Array.isArray(j?.results) ? j.results : [];
    if(!arr.length) throw new Error("Sem resultados");

    // escolhe o primeiro
    const r = arr[0];
    $("fLat").value = Number(r.latitude || 0);
    $("fLon").value = Number(r.longitude || 0);

    // tenta timezone se vier
    if(r.timezone) $("fTz").value = r.timezone;

    // cidade ‚Äúbonita‚Äù
    const nice = [r.name, r.admin1, r.country].filter(Boolean).join(" - ");
    $("fCidade").value = nice || name;

    rebuildJsonView();
    setStatus("Atualizado","ok");
    alert("Cidade aplicada:\n" + (nice || name));
  }catch(e){
    console.error(e);
    setStatus("Offline","bad");
    alert("N√£o consegui buscar coordenadas agora. Voc√™ pode preencher lat/lon manualmente.");
  }
}

/* ============================
   DOWNLOAD LOCAL
   ============================ */
function downloadJson(){
  if(!DATA){ alert("Carregue o data.json primeiro."); return; }
  rebuildJsonView();
  const blob = new Blob([prettyJson(DATA)], { type:"application/json;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "data.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
}

/* ============================
   COPY JSON
   ============================ */
async function copyJson(){
  if(!DATA){ alert("Carregue o data.json primeiro."); return; }
  rebuildJsonView();
  try{
    await navigator.clipboard.writeText(prettyJson(DATA));
    alert("JSON copiado.");
  }catch(e){
    alert("N√£o consegui copiar automaticamente. Selecione o texto no painel e copie manualmente.");
  }
}

/* ============================
   PUBLISH PARA GITHUB (Contents API)
   ============================ */
function b64EncodeUnicode(str){
  // base64 seguro para UTF-8
  return btoa(unescape(encodeURIComponent(str)));
}

async function ghGetSha(token){
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(GITHUB_PATH)}?ref=${encodeURIComponent(GITHUB_BRANCH)}`;
  const res = await fetch(url, {
    headers:{
      "Authorization":"Bearer " + token,
      "Accept":"application/vnd.github+json"
    }
  });
  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error("GitHub GET sha falhou: " + res.status + " " + txt);
  }
  const j = await res.json();
  return j?.sha || null;
}

async function ghPutFile(token, contentStr, sha){
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(GITHUB_PATH)}`;
  const body = {
    message: "Atualizar data.json via Admin",
    content: b64EncodeUnicode(contentStr),
    branch: GITHUB_BRANCH
  };
  if(sha) body.sha = sha;

  const res = await fetch(url, {
    method:"PUT",
    headers:{
      "Authorization":"Bearer " + token,
      "Accept":"application/vnd.github+json",
      "Content-Type":"application/json"
    },
    body: JSON.stringify(body)
  });

  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error("GitHub PUT falhou: " + res.status + " " + txt);
  }
  return await res.json();
}

async function publishToGitHub(){
  if(!DATA){ alert("Carregue o data.json primeiro."); return; }

  const token = getToken();
  if(!token){
    alert("Cole seu token e clique em 'Salvar token'.");
    return;
  }

  rebuildJsonView();
  const contentStr = prettyJson(DATA);

  try{
    setStatus("Publicando‚Ä¶","");
    const sha = await ghGetSha(token);
    await ghPutFile(token, contentStr, sha);

    setStatus("Publicado!","ok");
    alert("‚úÖ Publicado no GitHub!\nAguarde alguns segundos e atualize o painel do s√≠ndico.");
  }catch(e){
    console.error(e);
    setStatus("Erro","bad");
    alert("‚ùå Falha ao publicar.\n\n" + String(e.message || e));
  }
}

/* ============================
   ALERTA: BOT√ïES R√ÅPIDOS
   ============================ */
function alertOn(){
  $("fAlertAtivar").value = "true";
  rebuildJsonView();
  alert("Alerta ligado (ainda falta PUBLICAR).");
}
function alertOff(){
  $("fAlertAtivar").value = "false";
  rebuildJsonView();
  alert("Alerta desligado (ainda falta PUBLICAR).");
}

/* ============================
   UI BIND
   ============================ */
function bind(){
  $("btnSaveToken").onclick = saveToken;
  $("btnClearToken").onclick = clearToken;

  $("btnOpenPanel").onclick = ()=>{ window.open("./index.html", "_blank"); };

  $("btnLoad").onclick = loadData;
  $("btnDownload").onclick = downloadJson;
  $("btnPublish").onclick = publishToGitHub;

  $("btnRebuild").onclick = rebuildJsonView;
  $("btnCopyJson").onclick = copyJson;

  $("btnBuscarCidade").onclick = buscarCidade;

  $("btnAddVideo").onclick = addVideo;
  $("btnShuffleToggle").onclick = toggleShuffle;

  $("btnAlertOn").onclick = alertOn;
  $("btnAlertOff").onclick = alertOff;

  // Atualiza JSON ao editar qualquer campo
  const liveIds = [
    "fTitulo","fSubtitulo","fReferencia",
    "fRotInterval","fRotQtd",
    "fCidade","fLat","fLon","fTz",
    "fCabAtivar","fCabUrl",
    "fAlertAtivar","fAlertPiscar","fAlertTitulo","fAlertMsg"
  ];
  liveIds.forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("input", rebuildJsonView);
    el.addEventListener("change", rebuildJsonView);
  });
}

bind();
setStatus("Offline","bad");
</script>
</body>
</html>
