<div id="wxbar" style="
  position:fixed; left:0; right:0; bottom:0;
  padding:10px 14px; font:600 14px Arial, sans-serif;
  display:flex; gap:12px; align-items:center; justify-content:center;
  background:#0b223a; color:#fff; z-index:999999;
  border-top:1px solid rgba(255,255,255,.12);
">
  <span id="wxIcon">â³</span>
  <span id="wxText">Clima: carregandoâ€¦</span>
</div>

<script>
(async function () {
  const LAT = -28.4767;
  const LON = -49.0144;
  const TZ  = "America/Sao_Paulo";
  const bar = document.getElementById("wxbar");
  const iconEl = document.getElementById("wxIcon");
  const textEl = document.getElementById("wxText");

  function codeToEmoji(wmo) {
    // bÃ¡sico e eficiente para rodapÃ©
    if ([0].includes(wmo)) return "â˜€ï¸";
    if ([1,2,3].includes(wmo)) return "â›…";
    if ([45,48].includes(wmo)) return "ğŸŒ«ï¸";
    if ([51,53,55,56,57].includes(wmo)) return "ğŸŒ¦ï¸";
    if ([61,63,65,66,67,80,81,82].includes(wmo)) return "ğŸŒ§ï¸";
    if ([71,73,75,77,85,86].includes(wmo)) return "â„ï¸";
    if ([95,96,99].includes(wmo)) return "â›ˆï¸";
    return "ğŸŒ¡ï¸";
  }

  async function loadWeather() {
    // timeout para nÃ£o ficar â€œtravadoâ€ eternamente
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 8000);

    const url =
      "https://api.open-meteo.com/v1/forecast"
      + `?latitude=${LAT}&longitude=${LON}`
      + `&current=temperature_2m,weather_code`
      + `&hourly=precipitation_probability`
      + `&daily=temperature_2m_max,temperature_2m_min`
      + `&timezone=${encodeURIComponent(TZ)}`;

    try {
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(t);
      if (!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json();

      const temp = data?.current?.temperature_2m;
      const wmo  = data?.current?.weather_code;

      const dMax = data?.daily?.temperature_2m_max?.[0];
      const dMin = data?.daily?.temperature_2m_min?.[0];

      // alerta de chuva nas prÃ³ximas 3 horas (prob >= 50%)
      const times = data?.hourly?.time || [];
      const probs = data?.hourly?.precipitation_probability || [];
      const nowISO = data?.current?.time;
      const idx = times.indexOf(nowISO);
      let rainAlert = false;

      if (idx >= 0) {
        const next3 = probs.slice(idx, idx + 4); // agora + 3 horas
        rainAlert = next3.some(p => (typeof p === "number" && p >= 50));
      }

      iconEl.textContent = codeToEmoji(wmo);

      const txt =
        `Clima: ${Math.round(temp)}Â°C  |  MÃ¡x/MÃ­n: ${Math.round(dMax)}Â° / ${Math.round(dMin)}Â°`
        + (rainAlert ? "  â€”  ğŸŒ§ï¸ ALERTA de chuva (prÃ³x. horas)" : "");

      textEl.textContent = txt;

      // cor do rodapÃ©
      bar.style.background = rainAlert ? "#5a1b1b" : "#0b223a";

    } catch (e) {
      clearTimeout(t);
      iconEl.textContent = "âš ï¸";
      textEl.textContent = "Clima indisponÃ­vel (verifique conexÃ£o/console).";
      bar.style.background = "#3a2a0b";
      // importante: vocÃª nÃ£o fica â€œpresoâ€ no carregandoâ€¦
    }
  }

  await loadWeather();
  setInterval(loadWeather, 10 * 60 * 1000); // a cada 10 min
})();
</script>
