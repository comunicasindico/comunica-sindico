<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Comunica S√≠ndico - Cond√¥minos</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png">

<style>
:root{
--bg1:#061726;
--bg2:#0b1f33;
--txt:#eaf2ff;
--muted:rgba(234,242,255,.75);
--radius:18px;
--shadow:0 14px 40px rgba(0,0,0,.35);
--line:rgba(255,255,255,.12);
--ui: clamp(1, calc(100vmin / 900), 2.1);
}

*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Segoe UI,Arial,sans-serif;color:var(--txt);}

body{
background:linear-gradient(180deg,var(--bg1),var(--bg2));
overflow:hidden;
}

.wrap{padding:12px;height:100%;}
.container{display:flex;flex-direction:column;height:100%;gap:10px;}

.topbar{
display:flex;align-items:center;justify-content:space-between;
background:rgba(8,28,46,.6);
padding:14px;border-radius:var(--radius);
box-shadow:var(--shadow);
}

.brand{display:flex;flex-direction:column}
#titulo{font-size:clamp(26px,3vw,48px);font-weight:900}
#subtitulo{font-size:14px;color:var(--muted)}

.rightInfo{display:flex;align-items:center;gap:10px}
.badge{
display:flex;align-items:center;gap:8px;
padding:8px 12px;border-radius:999px;
border:1px solid var(--line);
background:rgba(12,35,56,.55);
font-weight:900;
}
#wxIconTop svg{width:48px;height:48px}

.main{flex:1;display:grid;grid-template-columns:1.2fr .8fr;gap:10px}

.panel{
background:linear-gradient(180deg,rgba(15,43,69,.92),rgba(11,33,55,.92));
border-radius:var(--radius);
box-shadow:var(--shadow);
display:flex;flex-direction:column;
overflow:hidden;
}

.panelHead{
padding:10px;
background:rgba(7,20,34,.25);
font-weight:900;
}

.avisos{padding:12px;display:flex;flex-direction:column;gap:10px}

.aviso{
background:linear-gradient(180deg,rgba(20,60,95,.9),rgba(10,30,50,.9));
padding:14px;border-radius:14px;
border:1px solid rgba(255,255,255,.12);
}

.aviso .t{font-weight:900;font-size:20px}
.aviso .d{font-size:15px;line-height:1.3}

#adBox{display:none}

.newsBox{
background:rgba(8,24,40,.65);
border-radius:14px;
padding:10px;
}

.newsItem{
background:rgba(0,0,0,.2);
padding:10px;border-radius:10px;
margin-bottom:6px;
}

.newsFooter{font-size:11px;color:rgba(255,255,255,.6)}
.newsFooterItem{margin-left:8px;font-size:11px}

.ticker{
background:rgba(8,28,46,.6);
padding:10px;border-radius:var(--radius);
box-shadow:var(--shadow);
}

.tickerLine1{
display:flex;
flex-direction:column;
align-items:center;
text-align:center;
gap:4px;
}

#wxInline{
display:flex;
flex-direction:column;
align-items:center;
gap:2px;
margin-top:4px;
}

.wxL1{font-weight:900}
.wxL2{font-size:13px;color:var(--muted)}

.wxMiniSvg svg{
width:18px;height:18px;
filter:drop-shadow(0 3px 6px rgba(0,0,0,.35));
}

/* SVG anima√ß√µes */
.wxsvg .sun-rays{animation:rot 6s linear infinite;transform-origin:32px 32px}
@keyframes rot{from{transform:rotate(0)}to{transform:rotate(360deg)}}

.wxsvg .cloud{animation:float 3s ease-in-out infinite}
@keyframes float{50%{transform:translateX(2px)}}

.wxsvg .drops line{animation:rain 1.1s linear infinite}
@keyframes rain{100%{transform:translateY(8px);opacity:.2}}

</style>
</head>

<body>
<div class="wrap">
<div class="container">

<div class="topbar">
<div class="brand">
<div id="titulo">Comunica S√≠ndico - Cond√¥minos</div>
<div id="subtitulo">Painel Informativo</div>
</div>

<div class="rightInfo">
<div class="badge">
<span id="wxIconTop"></span>
<span id="clock">--:--</span>
</div>
</div>
</div>

<div class="main">
<section class="panel">
<div class="panelHead">üîî Avisos Importantes</div>
<div class="avisos" id="avisos"></div>
</section>

<aside class="panel" id="adBox">
<div class="panelHead">üì∞ Mensagens no Brasil</div>
<div class="newsBox">
<div id="newsBody"></div>
</div>
</aside>
</div>

<div class="ticker">
<div class="tickerLine1">
<span id="dataBiblica">‚Äî</span>
<span id="ref">‚Äî</span>

<div id="wxInline">
<div class="wxL1">
<span id="wxIconInline" class="wxMiniSvg"></span>
<span id="wxCityTemp">‚Äî</span>
</div>
<div class="wxL2" id="wxWindRain">‚Äî</div>
</div>
</div>
</div>

</div>
</div>


  <script>
/* ===========================
   UTIL
=========================== */
function pad2(n){ return String(n).padStart(2,"0"); }
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = (v==null?"":String(v)); }
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function decodeHtmlEntities_(s){
  const t = document.createElement("textarea");
  t.innerHTML = String(s ?? "");
  return t.value;
}
function normalizeText_(s){
  return decodeHtmlEntities_(s).replace(/\u00a0/g," ").replace(/\s+/g," ").trim();
}

/* ===========================
   REL√ìGIO
=========================== */
function tickClock(){
  const d = new Date();
  const hhmm = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  setText("clock", hhmm);
}
tickClock();
setInterval(tickClock, 1000);

/* ===========================
   VERS√çCULO (B√çBLICO-ANUAL)
=========================== */
function hojeKeyMMDD() {
  const d = new Date();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${mm}-${dd}`;
}

async function carregarVersiculo(data) {
  if (!data?.temaDoDia || data.temaDoDia.modo !== "biblico-anual") return;
  try {
    const res = await fetch("versiculos.json?ts=" + Date.now(), { cache: "no-store" });
    const v = await res.json();
    const key = hojeKeyMMDD();
    const texto = v?.versos?.[key];

    // linha 1 (pequeno) pode ser um cabe√ßalho curto
    setText("dataBiblica", v?.cabecalho || "üìñ");

    // vers√≠culo completo
    setText("ref", texto ? texto : (v?.titulo || "Verso n√£o encontrado"));
  } catch (e) {}
}

/* ===========================
   SVG CLIMA ‚Äî PREMIUM
=========================== */
function wxSvgSun(){
  return `
  <svg class="wxsvg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <g class="sun-rays" fill="none" stroke="rgba(255,220,120,.95)" stroke-width="3" stroke-linecap="round">
      <line x1="32" y1="6"  x2="32" y2="14"/>
      <line x1="32" y1="50" x2="32" y2="58"/>
      <line x1="6"  y1="32" x2="14" y2="32"/>
      <line x1="50" y1="32" x2="58" y2="32"/>
      <line x1="12" y1="12" x2="18" y2="18"/>
      <line x1="46" y1="46" x2="52" y2="52"/>
      <line x1="46" y1="18" x2="52" y2="12"/>
      <line x1="12" y1="52" x2="18" y2="46"/>
    </g>
    <circle cx="32" cy="32" r="12" fill="rgba(255,200,60,.98)"/>
    <circle cx="32" cy="32" r="12" fill="none" stroke="rgba(255,255,255,.25)" stroke-width="2"/>
  </svg>`;
}

function wxSvgCloud(){
  return `
  <svg class="wxsvg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <g class="cloud">
      <path d="M22 44h22a12 12 0 0 0 0-24 15 15 0 0 0-29-3A11 11 0 0 0 22 44z"
        fill="rgba(235,245,255,.92)"/>
      <path d="M22 44h22a12 12 0 0 0 0-24 15 15 0 0 0-29-3A11 11 0 0 0 22 44z"
        fill="none" stroke="rgba(255,255,255,.25)" stroke-width="2"/>
    </g>
  </svg>`;
}

function wxSvgRain(){
  return `
  <svg class="wxsvg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <g class="cloud">
      <path d="M20 40h24a11 11 0 0 0 0-22 14 14 0 0 0-27-3A10 10 0 0 0 20 40z"
        fill="rgba(235,245,255,.92)"/>
      <path d="M20 40h24a11 11 0 0 0 0-22 14 14 0 0 0-27-3A10 10 0 0 0 20 40z"
        fill="none" stroke="rgba(255,255,255,.25)" stroke-width="2"/>
    </g>
    <g class="drops" stroke="rgba(120,200,255,.95)" stroke-width="3" stroke-linecap="round">
      <line x1="26" y1="44" x2="24" y2="52"/>
      <line x1="34" y1="44" x2="32" y2="52"/>
      <line x1="42" y1="44" x2="40" y2="52"/>
    </g>
  </svg>`;
}

function wxSvgStorm(){
  return `
  <svg class="wxsvg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <g class="cloud">
      <path d="M18 40h26a11 11 0 0 0 0-22 14 14 0 0 0-27-3A10 10 0 0 0 18 40z"
        fill="rgba(235,245,255,.92)"/>
      <path d="M18 40h26a11 11 0 0 0 0-22 14 14 0 0 0-27-3A10 10 0 0 0 18 40z"
        fill="none" stroke="rgba(255,255,255,.25)" stroke-width="2"/>
    </g>
    <path class="bolt" d="M30 42l-4 10h6l-3 10 12-16h-6l3-4z"
      fill="rgba(255,210,80,.98)"/>
  </svg>`;
}

function wxSvgByCode(code){
  const c = Number(code);
  const isSun   = (c === 0);
  const isCloud = ([1,2,3,45,48].includes(c));
  const isRain  = ([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(c));
  const isStorm = ([95,96,99].includes(c));

  if(isSun)   return { label:"Ensolarado", svg: wxSvgSun() };
  if(isStorm) return { label:"Tempestade", svg: wxSvgStorm() };
  if(isRain)  return { label:"Chuva", svg: wxSvgRain() };
  if(isCloud) return { label:"Nublado", svg: wxSvgCloud() };
  return      { label:"Clima", svg: wxSvgCloud() };
}

function wxSetTopIconSvg(code){
  const top = document.getElementById("wxIconTop");
  if(!top) return;
  const o = wxSvgByCode(code);
  top.innerHTML = o.svg;
  top.setAttribute("role","img");
  top.setAttribute("aria-label", o.label);
}

function wxSetFooterMiniSvg(code){
  const el = document.getElementById("wxIconInline");
  if(!el) return;
  const o = wxSvgByCode(code);
  // mini: reusa o mesmo SVG, mas a classe .wxMiniSvg no container j√° reduz via CSS
  el.innerHTML = o.svg;
  el.setAttribute("role","img");
  el.setAttribute("aria-label", o.label);
}

/* ===========================
   CLIMA (rodap√© 2 linhas)
   linha 1: Tubar√£o/SC 22¬∞C
   linha 2: Vento 1 km/h ‚Ä¢ Chuva 0 mm + √≠cone mini
=========================== */
async function carregarClima(data){
  const c = data?.clima || {};
  const cidade = String(c.cidade || "Tubar√£o/SC");

  try{
    if(!c.latitude || !c.longitude) throw new Error("Sem coordenadas");

    const url =
      "https://api.open-meteo.com/v1/forecast" +
      `?latitude=${encodeURIComponent(c.latitude)}` +
      `&longitude=${encodeURIComponent(c.longitude)}` +
      `&current=temperature_2m,precipitation,weather_code,wind_speed_10m` +
      `&timezone=${encodeURIComponent(c.timezone || "America/Sao_Paulo")}`;

    const res = await fetch(url, { cache:"no-store" });
    const j = await res.json();
    const cur = j?.current;
    if(!cur) throw new Error("Sem current");

    const t = Math.round(cur.temperature_2m);
    const w = Math.round(cur.wind_speed_10m);
    const p = (cur.precipitation == null ? 0 : cur.precipitation);
    const code = Number(cur.weather_code);

    wxSetTopIconSvg(code);
    wxSetFooterMiniSvg(code);

    // ‚úÖ linha 1 (cidade + temp)
    setText("wxCityTemp", `${cidade} ${t}¬∞C`);

    // ‚úÖ linha 2 (vento + chuva)
    setText("wxWindRain", `Vento ${w} km/h ‚Ä¢ Chuva ${p} mm`);

  }catch(e){
    console.warn("Clima offline:", e);

    // topo fallback
    const top = document.getElementById("wxIconTop");
    if(top) top.innerHTML = wxSvgCloud();

    // rodap√© fallback
    const mini = document.getElementById("wxIconInline");
    if(mini) mini.innerHTML = wxSvgCloud();

    setText("wxCityTemp", `${cidade} ‚Äî¬∞C (offline)`);
    setText("wxWindRain", `Vento ‚Äî km/h ‚Ä¢ Chuva ‚Äî mm`);
  }
}

/* ===========================
   AVISOS (simples)
=========================== */
function prioridadeClass(p){
  const x = String(p || "").toLowerCase();
  if(x === "alta") return "alta";
  if(x === "m√©dia" || x === "media") return "media";
  return "baixa";
}

function renderAvisos(data){
  const root = document.getElementById("avisos");
  if(!root) return;
  root.innerHTML = "";

  const avisos = Array.isArray(data?.avisos) ? data.avisos : [];
  if(!avisos.length){
    root.innerHTML = `<div class="aviso baixa"><div class="t">Sem avisos</div><div class="d">‚Äî</div></div>`;
    return;
  }

  avisos.slice(0,3).forEach(a=>{
    const div=document.createElement("div");
    div.className = `aviso ${prioridadeClass(a.prioridade)}`;
    div.innerHTML = `
      <div class="t">${escapeHtml(a.titulo || "Aviso")}</div>
      <div class="d">${escapeHtml(a.descricao || "‚Äî")}</div>
    `;
    root.appendChild(div);
  });
}

/* ===========================
   MENSAGENS NO BRASIL (fonte(s) no final)
   - t√≠tulo j√° est√° no HTML: "üì∞ Mensagens no Brasil"
   - fontes: abaixo das not√≠cias, uma por linha
=========================== */
async function carregarMensagensCidade(){
  const newsBody = document.getElementById("newsBody");
  const adBox = document.getElementById("adBox");
  if(!newsBody || !adBox) return;

  try{
    const res = await fetch("./mensagens_cidade.json?ts=" + Date.now(), { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);

    const j = await res.json();
    const items = Array.isArray(j.items) ? j.items : [];

    if(!items.length){
      newsBody.innerHTML = `
        <div class="newsItem"><b>Sem mensagens no momento</b></div>
        <div class="newsFooter">Fonte: indispon√≠vel</div>
      `;
      adBox.style.display = "flex";
      return;
    }

    let html = "";
    const fontes = new Set();

    items.slice(0,8).forEach(x=>{
      let titulo = normalizeText_(x.titulo || x.title || "Mensagem");
      titulo = titulo.replace(/\s+‚Äì\s+Google\s+News$/i, "").trim();
      titulo = titulo.replace(/\s+\|\s+.*$/i, "").trim();
      if(!titulo) titulo = "Mensagem";

      if(x.fonte) fontes.add(normalizeText_(x.fonte));

      html += `<div class="newsItem">${escapeHtml(titulo)}</div>`;
    });

    let fontesHtml = "";
    if(fontes.size){
      fontesHtml = `<div class="newsFooter">Fonte:</div>`;
      fontes.forEach(f=>{
        fontesHtml += `<div class="newsFooterItem">${escapeHtml(f)}</div>`;
      });
    }else{
      fontesHtml = `<div class="newsFooter">Fonte: indispon√≠vel</div>`;
    }

    newsBody.innerHTML = html + fontesHtml;
    adBox.style.display = "flex";
  }catch(e){
    newsBody.innerHTML = `
      <div class="newsItem"><b>Mensagens indispon√≠veis</b></div>
      <div class="newsFooter">Fonte: news.google.com (offline)</div>
    `;
    adBox.style.display = "flex";
  }
}

/* ===========================
   LOAD PRINCIPAL
=========================== */
async function loadAll(){
  try{
    const res = await fetch("data.json?ts=" + Date.now(), { cache:"no-store" });
    const data = await res.json();

    renderAvisos(data);
    await carregarVersiculo(data);
    await carregarClima(data);
    await carregarMensagensCidade();

    return data;
  }catch(e){
    console.warn("data.json offline:", e);
  }
}
loadAll();
</script>
</body>
</html>
