<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />

  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <title>Comunica S√≠ndico ‚Äî Cond√¥minos</title>

  <!-- =========================================================
       PWA ‚Äî COND√îMINOS
       ========================================================= -->
  <link rel="manifest" href="./manifest-condominos.json" />
  <meta name="theme-color" content="#0c2338" />
  <link rel="icon" href="./assets/icons/icon-192x192.png" />

  <style>
    :root{
      --bg1:#051320;
      --bg2:#071c2e;
      --card:#0b2236;
      --card2:#0d2a44;
      --line:rgba(255,255,255,.10);
      --txt:rgba(245,250,255,.96);
      --mut:rgba(245,250,255,.70);
      --mut2:rgba(245,250,255,.55);
      --accent:#46d16b;
      --warn:#ff5a5a;
      --shadow: 0 14px 34px rgba(0,0,0,.45);
      --softShadow: 0 10px 26px rgba(0,0,0,.35);
      --font-soft: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans";
      --font-head: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans";
      --topbar-bg: url('./img/tubarao01.jpg');

      --news-bg: rgba(10, 30, 50, .45);
      --news-border: rgba(255,255,255,.10);
      --news-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 14px 34px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; padding:0; }
    body{
      font-family: var(--font-soft);
      background: radial-gradient(1200px 800px at 30% 20%, #0c2b45 0%, rgba(7,28,46,.2) 40%, rgba(0,0,0,0) 70%),
                  linear-gradient(180deg, var(--bg2), var(--bg1));
      color:var(--txt);
      overflow:hidden;
    }

    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:12px;
      gap:10px;
    }

    .container{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* =========================
       TOPBAR
    ========================== */
    .topbar{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      padding:14px 16px 12px;
      background: linear-gradient(180deg, rgba(0,0,0,.30), rgba(0,0,0,.55)),
                  var(--topbar-bg) center/cover no-repeat;
      box-shadow: var(--softShadow);
      border:1px solid rgba(255,255,255,.10);
    }
    .topbar::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(0,0,0,.55), rgba(0,0,0,.15));
      pointer-events:none;
    }

    .topRow{
      position:relative;
      z-index:2;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .title{
      font-family: var(--font-head);
      font-weight: 950;
      text-transform:uppercase;
      letter-spacing:1.4px;
      font-size: clamp(22px, 3.3vw, 54px);
      line-height:1.05;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      filter: drop-shadow(0 3px 8px rgba(0,0,0,.55));
    }

    .sub{
      font-weight: 850;
      font-size: clamp(12px, 1.35vw, 18px);
      color: rgba(240,248,255,.92);
      letter-spacing:.2px;
      opacity:.95;
    }

    .rightInfo{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      flex:0 0 auto;
      min-width: 210px;
    }

    .statusLine{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-weight: 900;
      font-size: 14px;
    }

    .dot{
      width:10px; height:10px;
      border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(70,209,107,.15);
    }

    .clockPill{
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      font-weight: 950;
      font-size: 14px;
      letter-spacing:.2px;
      min-width: 72px;
      text-align:center;
    }

    .panelInfo{
      font-weight: 950;
      color: rgba(240,248,255,.90);
      opacity:.95;
      font-size: 14px;
      text-transform: none;
    }

    /* CELULAR: linha compacta (modelo que voc√™ pediu) */
    .subMobileLine{
      display:none;
      font-weight: 900;
      font-size: 13px;
      color: rgba(240,248,255,.92);
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .subMobileLine .sep{ opacity:.55; }

    /* =========================
       MAIN
    ========================== */
    .main{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .sectionBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(12,35,56,.55);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--softShadow);
    }

    .sectionTitle{
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .9px;
      font-size: 14px;
      color: rgba(240,248,255,.95);
    }

    .pill{
      padding:8px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      font-weight: 950;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .pill:active{ transform: translateY(1px); }

    .fade-in{ animation: fadeIn .28s ease both; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }

    .quadTop{
      flex:1 1 auto;
      min-height:0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr; /* 3 linhas */
      gap:10px;
      width:100%;
      height:100%;
      position:relative;
    }

    /* ====== Layout exatamente como o print ======
       Linha 1: slot1 | slot2
       Linha 2: slot3 | slot4 (v√≠deo come√ßa)
       Linha 3: slot5 | slot4 (v√≠deo continua)  ==> 4 + 6 juntos
    ============================================= */
    #slot1{ grid-column:1; grid-row:1; }
    #slot2{ grid-column:2; grid-row:1; }
    #slot3{ grid-column:1; grid-row:2; }

    #slot5{ grid-column:1; grid-row:3; }

    /* ‚úÖ V√≠deo grande: ocupa coluna 2, linhas 2 e 3 (4 + 6 juntos) */
    #slot4{ grid-column:2; grid-row:2 / 4; }

    .tile{ min-height:0; overflow:hidden; display:flex; flex-direction:column; }
    .tileBody{
      padding:12px;
      min-height:0;
      flex:1 1 auto;
      overflow:hidden;
      display:flex;
    }

    @keyframes avisoIn{
      from{ opacity:0; transform: translateY(8px) scale(.995); }
      to  { opacity:1; transform: translateY(0) scale(1); }
    }

    .aviso{
      height:100%;
      width:100%;
      padding:16px 16px 12px 18px;
      border-radius:16px;
      background:linear-gradient(180deg, rgba(20,60,95,.88), rgba(10,30,50,.88));
      display:flex;
      flex-direction:column;
      gap:10px;
      border:1px solid rgba(140,200,255,.22);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.14),
        inset 0 -14px 22px rgba(0,0,0,.28),
        0 14px 34px rgba(0,0,0,.45);
      animation: avisoIn .22s ease both;
      overflow:hidden;
      position:relative;
    }

    .aviso::before{
      content:"";
      position:absolute;
      inset:10px auto 10px 10px;
      width:6px;
      border-radius:999px;
      background:rgba(255,255,255,.15);
    }

    .aviso.alta{
      border:1px solid rgba(255,90,90,.9);
      background:linear-gradient(180deg, rgba(255,80,80,.28), rgba(12,30,50,.92));
    }
    .aviso.alta::before{ background:linear-gradient(180deg,#ff5a5a,#c0392b); }

    .avTitle{
      font-weight: 980;
      font-size: clamp(14px, 2.0dvh, 22px);
      letter-spacing:.3px;
      margin:0;
    }
    .avDesc{
      font-weight: 760;
      font-size: clamp(13px, 2.15dvh, 24px);
      line-height: 1.18;
      color: rgba(240,248,255,.95);
      margin:0;
      overflow:hidden;
      display:-webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 6;
    }

    .avMeta{
      margin-top:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size: 12px;
      font-weight: 900;
      color: rgba(240,248,255,.80);
      opacity:.95;
    }
    .chip{
      padding:3px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.24);
      border:1px solid rgba(255,255,255,.10);
      font-weight: 950;
      letter-spacing:.15px;
    }

    /* =========================
       V√çDEO / PUBLICIDADE
    ========================== */
    #slot4{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    #slot4 .videoWrap{
      width:100%;
      height:auto;
      min-height:0;
      border-radius:14px;
      overflow:hidden;
      position:relative;
      background:#000;
      flex:1 1 auto;
    }

    /* TV e Desktop: v√≠deo cresce junto com o slot (4 + 6),
       preenchendo todo o espa√ßo dispon√≠vel */
    #slot4 video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      background:#000;
    }

    .adNav{
      position:absolute;
      z-index:6;
      top:50%;
      transform: translateY(-50%);
      width:42px;
      height:42px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.45);
      color: rgba(255,255,255,.92);
      font-size: 18px;
      font-weight: 900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      opacity:.85;
    }
    .adNav:hover{ opacity:1; }
    .adPrev{ left:10px; }
    .adNext{ right:10px; }

    .videoBg{ filter: blur(12px) saturate(1.2); opacity:.40; }
    .videoMain{ z-index:2; }

    .adBelow{
      flex:0 0 auto;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      padding:10px 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .adBelowText{
      font-weight: 950;
      font-size: clamp(12px, 1.65dvh, 20px);
      color: rgba(240,248,255,.92);
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    video::-webkit-media-controls{ display:none !important; }
    video::-webkit-media-controls-panel{ display:none !important; }
    video::-webkit-media-controls-enclosure{ display:none !important; }

    /* =========================
       MENSAGENS NO BRASIL
    ========================== */
    .newsBox{
      flex:0 0 auto;
      background: var(--news-bg);
      border: 1px solid var(--news-border);
      box-shadow: var(--news-shadow);
      border-radius: 18px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .newsHead{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(12,35,56,.35);
      flex:0 0 auto;
    }

    .newsTitle{ font-weight:950; color:rgba(234,242,255,.95); }
    #newsPill{ display:none !important; }

    #newsBody{
      padding: 10px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height:0;
      flex:1 1 auto;
      overflow:hidden;
    }

    .newsItem{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      padding: 10px 10px 9px;
      overflow:hidden;
    }

    .newsItem .h{
      font-family: var(--font-soft);
      font-weight: 820;
      font-size: clamp(11px, 1.25dvh, 15px);
      line-height: 1.18;
      letter-spacing: .12px;
      color: rgba(234,242,255,.95);
      margin: 0;
      display:block;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .newsSourceLine{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(234,242,255,.72);
      font-weight: 900;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* =========================
       ALERTA URGENTE
    ========================== */
    .urgentBox{
      border-radius:18px;
      border:1px solid rgba(255,90,90,.55);
      background: linear-gradient(180deg, rgba(255,80,80,.20), rgba(12,30,50,.85));
      box-shadow: var(--shadow);
      padding:12px 14px;
    }
    .urgentTitle{
      font-weight: 1000;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: rgba(255,240,240,.96);
      margin-bottom:6px;
    }
    .urgentMsg{
      font-weight: 900;
      font-size: clamp(14px, 2.2dvh, 26px);
      line-height:1.15;
      color: rgba(255,250,250,.97);
    }

    .alertBox{
      display:none;
      border-radius:18px;
      border:1px solid rgba(255,90,90,.55);
      background: linear-gradient(180deg, rgba(255,80,80,.20), rgba(12,30,50,.85));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .alertHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
    }
    .alertTitle{ font-weight:1000; letter-spacing:1px; text-transform:uppercase; }
    .alertBody{ padding:12px 14px; }
    .alertMsg{
      margin:0;
      font-weight:950;
      font-size: clamp(14px, 2.35dvh, 28px);
      line-height:1.12;
    }
    .blink{ animation: blink 1s infinite; }
    @keyframes blink{
      0%,100%{ filter:none; }
      50%{ filter: brightness(1.25) saturate(1.2); }
    }

    /* =========================
       TICKER / RODAP√â
    ========================== */
    .ticker{
      flex:0 0 auto;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,35,56,.55);
      box-shadow: var(--softShadow);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:44px;
    }
    .tickerLine1{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      font-weight: 950;
      color: rgba(240,248,255,.92);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .tickerIcon{ font-size: 18px; }
    .tickerLine2{
      display:flex;
      align-items:center;
      gap:12px;
      color: rgba(240,248,255,.86);
      font-weight: 900;
      white-space:nowrap;
    }

    /* =========================================================
       MOBILE / TV DETECT
       ========================================================= */
    @media (max-width: 980px){
      html.isTV:not(.isPortrait) .quadTop{
        display:grid !important;
        grid-template-columns: 1fr 1fr !important;
        grid-template-rows: 1fr 1fr 1fr !important;
        gap:10px !important;
      }

      html.isMobileUA:not(.isTV) .topbar{
        padding:12px 12px 10px;
      }
      html.isMobileUA:not(.isTV) .title{
        font-size: 20px;
        letter-spacing: 1px;
      }
      html.isMobileUA:not(.isTV) .sub{ display:none; }
      html.isMobileUA:not(.isTV) .subMobileLine{
        display:flex;
      }

      html.isMobileUA:not(.isTV) .rightInfo{ display:none; }

      /* ‚úÖ MOBILE: garantir altura do v√≠deo (publicidade) */
      html.isMobileUA:not(.isTV) #slot4{
        display:block !important;
        padding:12px !important;
        min-height: 220px;
      }

      html.isMobileUA:not(.isTV) #slot4 .videoWrap{
        width:100% !important;
        aspect-ratio: 16 / 9;
        height:auto !important;
        min-height: 220px;
        position:relative;
      }
      html.isMobileUA:not(.isTV) #slot4 video{
        position:absolute;
        inset:0;
      }
    }

    /* TV em p√©: permitir rolagem (voc√™ pediu) */
    html.isTV.isPortrait body{ overflow:auto; }

    /* Banner de atualiza√ß√£o PWA */
    #updateBanner{
      display:none;
      position:fixed;
      left:12px;
      right:12px;
      bottom:12px;
      z-index:99;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-weight: 950;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="container">

      <!-- =========================================================
           IN√çCIO ‚Äî HEADER (TOPBAR)
           ========================================================= -->
      <div class="topbar">
        <div class="topRow">
          <div class="brand">
            <div class="title" id="titulo">Comunica S√≠ndico - Cond√¥minos</div>
            <div class="sub" id="subtitulo">Painel Informativo</div>

            <!-- CELULAR: linha compacta -->
            <div class="subMobileLine" id="subMobileLine">
              <span id="subInfoLabel">Painel Informativo</span>
              <span class="sep">¬∫</span>
              <span id="statusJsonMini">Carregando...</span>
              <span class="sep">¬∫</span>
              <span id="clockMini">--:--</span>
            </div>
          </div>

          <div class="rightInfo">
            <div class="statusLine">
              <span class="dot" id="dotOnline"></span>
              <span id="statusJson">Atualizado automaticamente</span>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
              <div class="clockPill" id="clock">--:--</div>
              <div class="panelInfo" id="panelInfo">Painel informativo</div>
            </div>
          </div>
        </div>
      </div>

      <!-- =========================================================
           IN√çCIO ‚Äî MAIN
           ========================================================= -->
      <div class="main">

        <div class="sectionBar">
          <div class="sectionTitle">Avisos</div>
          <div class="pill" id="refPill" title="Clique para atualizar">Atualizar</div>
        </div>

        <div class="quadTop fade-in" id="avisosPane">
          <div class="panel tile"><div class="tileBody" id="slot1"></div></div>
          <div class="panel tile"><div class="tileBody" id="slot2"></div></div>
          <div class="panel tile"><div class="tileBody" id="slot3"></div></div>

          <!-- V√≠deo (bloco √∫nico grande) -->
          <div class="panel tile">
            <div class="tileBody" id="slot4">

              <div class="videoWrap">
                <button class="adNav adPrev" type="button" onclick="adPrevBtn()" aria-label="Anterior">‚èÆ</button>
                <button class="adNav adNext" type="button" onclick="adNextBtn()" aria-label="Pr√≥ximo">‚è≠</button>

                <video id="adVideoBg" class="videoBg" autoplay muted playsinline webkit-playsinline loop
                  disablepictureinpicture controlslist="nofullscreen noremoteplayback nodownload"></video>
                <video id="adVideo" class="videoMain" autoplay muted playsinline webkit-playsinline
                  disablepictureinpicture controlslist="nofullscreen noremoteplayback nodownload"></video>
              </div>

              <div class="adBelow">
                <div class="adBelowText" id="adLabelBelow">‚Äî</div>
              </div>

            </div>
          </div>

          <!-- Mensagens no Brasil ‚Äî √† esquerda sempre -->
          <div class="tile" id="slot5">
            <div class="newsBox" id="newsBox" style="display:none">
              <div class="newsHead">
                <div class="newsTitle" id="cityTitle">üì∞ Mensagens no Brasil</div>
                <div class="pill" id="newsPill">‚Äî</div>
              </div>
              <div id="newsBody"></div>
            </div>
          </div>
        </div>

        <div class="urgentBox" id="urgentBox" style="display:none">
          <div class="urgentTitle" id="urgentTitle">ALERTA URGENTE</div>
          <div class="urgentMsg" id="urgentMsg">‚Äî</div>
        </div>

        <!-- ALERTA URGENTE (ocupa o lugar das mensagens quando ativado) -->
        <div class="alertBox" id="alertBox" style="display:none">
          <div class="alertHead">
            <div class="alertTitle" id="alertTitle">ALERTA URGENTE</div>
            <div class="pill" id="alertOffBtn" title="Desligar alerta">Desligar</div>
          </div>
          <div class="alertBody">
            <p class="alertMsg" id="alertMsg">‚Äî</p>
          </div>
        </div>

      </div>

      <!-- =========================================================
           IN√çCIO ‚Äî RODAP√â (TICKER)
           ========================================================= -->
      <div class="ticker">
        <div class="tickerLine1">
          <span class="tickerIcon">üìñ</span>
          <span id="dataBiblica">‚Äî</span>
          <span id="ref">‚Äî</span>
        </div>
        <div class="tickerLine2">
          <span id="cidadeClima">‚Äî</span>
          <span id="tempClima">‚Äî</span>
          <span id="ventoClima">‚Äî</span>
          <span id="chuvaClima">‚Äî</span>
        </div>
      </div>

    </div>
  </div>

  <div id="updateBanner">Atualiza√ß√£o dispon√≠vel ‚Äî recarregando...</div>

  <script>
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }
    function setText(id, val){
      const el = document.getElementById(id);
      if(el) el.textContent = String(val ?? "");
    }

    // =========================
    // Detect TV / Mobile
    // =========================
    (function detectEnv(){
      const ua = (navigator.userAgent || "").toLowerCase();
      const isTua =
        ua.includes("bravia") || ua.includes("sonydtv") ||
        ua.includes("netcast") || ua.includes("tizen") ||
        ua.includes("webos") || ua.includes("webos") ||
        ua.includes("viera") || ua.includes("roku") ||
        ua.includes("aft") || ua.includes("tv");

      // 1) For√ßa manual: use ?tv=1 na URL (recomendado para SEMP/BrowseHere)
      const qs = new URLSearchParams(location.search);
      const forceTV = (qs.get("tv") === "1");

      // 2) BrowseHere (SEMP): trate como TV
      const isBrowseHere = ua.includes("browsehere") || ua.includes("browse here");

      // ‚Äútamanho f√≠sico‚Äù (screen.* n√£o muda com zoom)
      const sw = Number(screen.width || 0);
      const sh = Number(screen.height || 0);
      const maxS = Math.max(sw, sh);
      const minS = Math.min(sw, sh);

      // Heur√≠stica forte: telas grandes
      const isPhysBig = (maxS >= 960 && minS >= 540) || (maxS >= 1280 && minS >= 720);

      // viewport grande (fallback)
      const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
      const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
      const isViewportBig = (Math.max(vw, vh) >= 1100 && Math.min(vw, vh) >= 650);

      // TV final: for√ßado OU BrowseHere OU heur√≠sticas (quando n√£o √© mobile UA)
      const looksMobileUA = /mobi|iphone|ipod|ipad|android.*mobile/.test(ua);
      const isTV = !!(forceTV || isBrowseHere || (!looksMobileUA && (isTua || isPhysBig || isViewportBig)));

      // mobile UA (N√ÉO pega TV / BrowseHere)
      const isMobileUA = !!(looksMobileUA && !isTV && !isBrowseHere);

      // orienta√ß√£o (para permitir rolagem na TV SOMENTE se estiver vertical)
      function applyOrientation(){
        const w = Math.max(window.innerWidth || 0, document.documentElement.clientWidth || 0);
        const h = Math.max(window.innerHeight || 0, document.documentElement.clientHeight || 0);
        const isPortrait = h > w;
        document.documentElement.classList.toggle("isPortrait", isPortrait);
      }

      document.documentElement.classList.toggle("isTV", isTV);
      document.documentElement.classList.toggle("isMobileUA", isMobileUA);

      applyOrientation();
      window.addEventListener("resize", applyOrientation);
      window.addEventListener("orientationchange", applyOrientation);
    })();

    function isMobile(){ return document.documentElement.classList.contains("isMobileUA"); }

    // =========================
    // CLOCK
    // =========================
    function tickClock(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      setText("clock", hh + ":" + mm);
      setText("clockMini", hh + ":" + mm);
    }
    tickClock();
    setInterval(tickClock, 1000);

    // =========================
    // Avisos
    // =========================
    function getAvisos(data){
      const a = data?.avisos;
      if(Array.isArray(a)) return a;
      const b = data?.avisosDoCondominio;
      if(Array.isArray(b)) return b;
      return [];
    }

    function get3Avisos(a){
      const list = Array.isArray(a) ? a.slice() : [];
      if(!list.length) return [{titulo:"Sem avisos", descricao:"Nenhum aviso cadastrado no momento."}];
      return list.slice(0,3);
    }

    function renderAviso(el, item){
      if(!el) return;
      const alta = (String(item?.prioridade || "").toLowerCase().includes("alta")) || !!item?.alta;
      const titulo = escapeHtml(item?.titulo || item?.title || "Aviso");
      const desc   = escapeHtml(item?.descricao || item?.desc || item?.mensagem || "‚Äî");

      const local  = escapeHtml(item?.local || item?.setor || "");
      const tipo   = escapeHtml(item?.tipo || "");
      const nivel  = escapeHtml(item?.nivel || item?.urgencia || "");

      const ini = escapeHtml(item?.inicio || item?.inicioEm || item?.dataInicio || "");
      const fim = escapeHtml(item?.fim || item?.fimEm || item?.dataFim || "");

      const chips = [];
      if(local) chips.push(`üìç ${local}`);
      if(tipo)  chips.push(`üè∑Ô∏è ${tipo}`);
      if(nivel) chips.push(`<span class="chip">${nivel}</span>`);
      if(ini || fim) chips.push(`üóìÔ∏è ${ini}${(ini && fim) ? " ‚Äî " : ""}${fim}`);

      el.innerHTML = `
        <div class="aviso ${alta ? "alta" : ""}">
          <p class="avTitle">${titulo}</p>
          <p class="avDesc">${desc}</p>
          <div class="avMeta">${chips.join(" ‚Ä¢ ")}</div>
        </div>
      `;
    }

    function renderAvisos(data){
      const avisos = get3Avisos(getAvisos(data));
      renderAviso(document.getElementById("slot1"), avisos[0] || {});
      renderAviso(document.getElementById("slot2"), avisos[1] || {});
      renderAviso(document.getElementById("slot3"), avisos[2] || {});
      requestAnimationFrame(()=>{ try{ autoFitAvisosUniform(); }catch(e){} });
    }

    // Ajusta fonte uniformemente (deixa todos no padr√£o do ‚Äúmaior‚Äù com seguran√ßa)
    function autoFitAvisosUniform(){
      const els = [document.querySelector("#slot1 .avDesc"), document.querySelector("#slot2 .avDesc"), document.querySelector("#slot3 .avDesc")].filter(Boolean);
      if(!els.length) return;

      // mede o maior font-size atual (px)
      const sizes = els.map(e => parseFloat(getComputedStyle(e).fontSize || "0")).filter(n=>isFinite(n));
      let base = Math.max(...sizes, 14);

      // tenta aumentar at√© limite sem estourar
      const maxTry = base * 1.15;
      const step = 0.5;
      let best = base;

      function fits(){
        return els.every(e => e.scrollHeight <= e.clientHeight + 2);
      }

      // aplica base primeiro
      els.forEach(e => e.style.fontSize = best + "px");

      // tenta crescer at√© maxTry
      for(let s = best; s <= maxTry; s += step){
        els.forEach(e => e.style.fontSize = s + "px");
        if(fits()) best = s;
        else break;
      }

      // aplica o melhor
      els.forEach(e => e.style.fontSize = best + "px");
    }

    // =========================
    // Publicidade (v√≠deos)
    // =========================
    function adLoadState(){
      try{
        const s = localStorage.getItem("ad_state_v2");
        if(!s) return {};
        return JSON.parse(s) || {};
      }catch(e){ return {}; }
    }
    function adSaveState(st){
      try{ localStorage.setItem("ad_state_v2", JSON.stringify(st || {})); }catch(e){}
    }

    function adFilterMp4(list){
      const arr = Array.isArray(list) ? list : [];
      return arr.filter(x => String(x?.arquivo||"").toLowerCase().match(/\.(mp4|webm|m4v|mov|avi)(\?.*)?$/));
    }

    function adGetShuffledList(list){
      const a = list.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function adNext(videos){
      try{
        const st = adLoadState();
        let idx = Number.isFinite(st.idx) ? st.idx : 0;
        idx = (idx + 1) % videos.length;
        st.idx = idx;
        st.t = 0;
        st.paused = false;
        adSaveState(st);
        adPlayByState(videos, true);
      }catch(e){}
    }

    function adPrevBtn(){
      try{
        const data = window.__lastDataForTopbar || {};
        const pub = data.publicidade || {};
        const videosMp4 = adFilterMp4(pub.videos);
        if(!videosMp4.length) return;

        const st = adLoadState();
        let idx = Number.isFinite(st.idx) ? st.idx : 0;
        idx = idx - 1;
        if(idx < 0) idx = videosMp4.length - 1;

        st.idx = idx;
        st.t = 0;
        st.paused = false;
        adSaveState(st);

        adPlayByState(videosMp4, true);
      }catch(e){}
    }
    function adNextBtn(){
      try{
        const data = window.__lastDataForTopbar || {};
        const pub = data.publicidade || {};
        const videosMp4 = adFilterMp4(pub.videos);
        if(!videosMp4.length) return;
        adNext(videosMp4);
      }catch(e){}
    }

    function adPlayByState(videos, forceFromStart){
      const adVideo = document.getElementById("adVideo");
      const adVideoBg = document.getElementById("adVideoBg");
      const adBelow = document.getElementById("adLabelBelow");
      if(!adVideo || !adVideoBg) return;

      let list = Array.isArray(videos) ? videos : [];
      if(!list.length) return;

      try{
        const cfg = (window.__lastDataForTopbar || {});
        const pub = cfg?.publicidade || {};
        if (pub.shuffle) list = adGetShuffledList(list);
      }catch(e){}

      const st = adLoadState();
      let idx = Number.isFinite(st.idx) ? st.idx : 0;
      if(idx < 0) idx = 0;
      if(idx >= list.length) idx = 0;

      const item = list[idx];
      const src = String(item?.arquivo || "");
      const sep = src.includes("?") ? "&" : "?";
      const finalSrc = src ? (src + sep + "ts=" + Date.now()) : "";

      if(adBelow) adBelow.textContent = String(item?.anunciante || "‚Äî");

      const cur = adVideo.currentSrc || adVideo.src || "";
      const baseCur = cur.split("?")[0];
      const baseNext = finalSrc.split("?")[0];

      // troca somente se mudou ou se for√ßar rein√≠cio
      if(forceFromStart || !baseCur || baseCur !== baseNext){
        try{
          adVideo.pause(); adVideoBg.pause();
        }catch(e){}

        adVideoBg.src = finalSrc;
        adVideo.src = finalSrc;

        adVideoBg.load();
        adVideo.load();

        const play = ()=>{ adVideo.play().catch(()=>{}); adVideoBg.play().catch(()=>{}); };
        setTimeout(play, 50);
      }else{
        // garante que est√° tocando
        adVideo.play().catch(()=>{});
        adVideoBg.play().catch(()=>{});
      }
    }

    function iniciarPublicidade(data){
      const pub = data?.publicidade;
      if (!pub?.ativar) return;

      const videosMp4 = adFilterMp4(pub?.videos);
      if (!videosMp4.length) return;

      const v = document.getElementById("adVideo");
      if(!v) return;

      v.onended = () => adNext(videosMp4);
      v.onerror = () => setTimeout(()=>adNext(videosMp4), 1200);

      adPlayByState(videosMp4, true);
    }

    function decodeHtmlEntities_(s){
      const t = document.createElement("textarea");
      t.innerHTML = String(s ?? "");
      return t.value;
    }
    function normalizeText_(s){
      return decodeHtmlEntities_(s).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
    }

    function getNewsMaxItems(){
      // Pedido: caber / reduzir para 3 mensagens no painel (PC/TV)
      if (isMobile()) return 8;
      return 3;
    }

    async function carregarMensagensCidade(){
      const newsBox  = document.getElementById("newsBox");
      const newsBody = document.getElementById("newsBody");
      if(!newsBox || !newsBody) return;

      try{
        const res = await fetch("./mensagens_cidade.json?ts=" + Date.now(), { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);

        const j = await res.json();
        const items = Array.isArray(j.items) ? j.items : [];
        const maxItems = getNewsMaxItems();

        // ‚úÖ filtro ‚Äúmais alegre‚Äù (evita crimes/trag√©dias) + prioriza mensagens positivas
        const badRe = /(assassin|homicid|morte|morrer|corpo|tiro|bala|fac[c√ß][a√£]o|trafi[c√ß]|drog|roub|furto|sequest|estupr|viol[√™e]n|pris[a√£]o|pol[i√≠]cia|arma|latroc[i√≠]nio|crime|trag[e√©]dia|desastre)/i;
        const goodRe = /(boa|boas|feliz|alegr|celebr|vit[o√≥]ria|progres|melhor|solidar|amor|esperan[c√ß]a|sa[u√∫]de|educa[c√ß][a√£]o|cultura|esporte|oportun|inova[c√ß][a√£]o|supera[c√ß][a√£]o)/i;
        const scored = items.map(it => {
          const raw = (it && (it.titulo || it.title || "")) || "";
          const title = normalizeText_(raw);
          const bad = badRe.test(title);
          const good = goodRe.test(title);
          const score = (good ? 2 : 0) + (bad ? -5 : 0);
          return { it, title, bad, good, score };
        });
        // 1) remove ‚Äúbad‚Äù; 2) mant√©m pelo menos algo se tudo for ‚Äúbad‚Äù
        let safeItems = scored.filter(s => !s.bad).sort((a,b)=>b.score-a.score).map(s=>s.it);
        if(!safeItems.length) safeItems = items.slice();

        if(!safeItems.length){
          newsBody.innerHTML = `
            <div class="newsItem"><p class="h">Sem mensagens no momento</p></div>
            <div class="newsSourceLine">Fonte: indispon√≠vel</div>
          `;
          newsBox.style.display = "flex";
          return;
        }

        let html = "";
        const fontes = new Set();

        safeItems.slice(0, maxItems).forEach(x=>{
          let titulo = normalizeText_(x.titulo || x.title || "Mensagem");
          titulo = titulo.replace(/\s+‚Äì\s+Google\s+News$/i, "").trim();
          titulo = titulo.replace(/\s+\|\s+.*$/i, "").trim();
          if(!titulo) titulo = "Mensagem";
          if(x.fonte) fontes.add(normalizeText_(x.fonte));
          html += `<div class="newsItem"><p class="h">${escapeHtml(titulo)}</p></div>`;
        });

        let fonteLine = "";
        if(fontes.size){
          const joined = Array.from(fontes).join(" ‚Ä¢ ");
          fonteLine = `<div class="newsSourceLine">Fonte: ${escapeHtml(joined)}</div>`;
        }

        newsBody.innerHTML = html + fonteLine;
        newsBox.style.display = "flex";
      }catch(e){
        newsBody.innerHTML = `
          <div class="newsItem"><p class="h">Mensagens indispon√≠veis</p></div>
          <div class="newsSourceLine">Fonte: news.google.com (offline)</div>
        `;
        newsBox.style.display = "flex";
      }

      // se alerta estiver ativo, n√£o mostra Mensagens no Brasil
      try{
        const cfg = window.__lastDataForTopbar || {};
        if(cfg?.alertaUrgente?.ativar){
          if(newsBox) newsBox.style.display = "none";
          return;
        }
      }catch(e){}
    }

    function aplicarImagemTopbar(data){
      // Se Admin definiu imagem do cabe√ßalho, N√ÉO sobrescreve.
      try{
        const cab = data?.publicidade?.cabecalhoImagem || {};
        if(cab.ativar && String(cab.url||"").trim()) return;
      }catch(e){}
      const cidade = String(data?.clima?.cidade || "").toLowerCase();
      const isTubarao = cidade.includes("tubar√£o") || cidade.includes("tubarao");

      const h = new Date().getHours();
      const estaNoite = (h >= 18 || h <= 4);

      const isMob = isMobile();
      const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
      const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
      const longest = Math.max(vw, vh);

      const is2560 = longest >= 2400;
      const is1920 = longest >= 1700;

      let img = "./img/tubarao01.jpg";
      if(!isTubarao){
        img = estaNoite ? "./img/bg_night.jpg" : "./img/bg_day.jpg";
      }else{
        if(is2560) img = estaNoite ? "./img/tubarao_night_2560.jpg" : "./img/tubarao_day_2560.jpg";
        else if(is1920) img = estaNoite ? "./img/tubarao_night_1920.jpg" : "./img/tubarao_day_1920.jpg";
        else img = estaNoite ? "./img/tubarao_night.jpg" : "./img/tubarao_day.jpg";
      }

      // mobile economiza (opcional)
      if(isMob) img = "./img/tubarao01.jpg";

      document.documentElement.style.setProperty("--topbar-bg", `url('${img}')`);
    }

    function applyUrgentBox(data){
      try{
        const u = data?.alertaUrgente;
        const urgentBox = document.getElementById("urgentBox");
        const alertBox  = document.getElementById("alertBox");
        if(!urgentBox || !alertBox) return;

        const on = !!(u?.ativar && String(u?.mensagem||"").trim());
        document.documentElement.classList.toggle("urgentOn", on);

        if(on){
          const blink = !!u?.piscar;
          const title = String(u?.titulo || "ALERTA URGENTE");
          const msg   = String(u?.mensagem || "‚Äî");
          setText("urgentTitle", title);
          setText("urgentMsg", msg);
          urgentBox.style.display = "block";

          setText("alertTitle", title);
          setText("alertMsg", msg);
          alertBox.style.display = "block";
          alertBox.classList.toggle("blink", blink);

          // oculta mensagens
          const newsBox = document.getElementById("newsBox");
          if(newsBox) newsBox.style.display = "none";
        }else{
          urgentBox.style.display = "none";
          alertBox.style.display = "none";
          alertBox.classList.remove("blink");
          document.documentElement.classList.remove("urgentOn");
        }
      }catch(e){}
    }

    async function fetchDataJson(){
      const url = "./data.json?ts=" + Date.now();
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }

    function updateStatus(ok){
      const dot = document.getElementById("dotOnline");
      const s1 = document.getElementById("statusJson");
      const s2 = document.getElementById("statusJsonMini");
      if(dot) dot.style.background = ok ? "#2ecc71" : "#ff5a5a";
      if(s1) s1.textContent = ok ? "Atualizado automaticamente" : "Offline";
      if(s2) s2.textContent = ok ? "Atualizado automaticamente" : "Offline";
    }

    // Vers√≠culo (fallback simples se n√£o houver arquivo)
    async function carregarVersiculo(data){
      try{
        const modo = data?.temaDoDia?.modo;
        const arq = data?.temaDoDia?.arquivo || "./versiculos.json";
        const fallback = data?.temaDoDia?.fallback || "Deus √© fiel e n√£o permitir√° prova al√©m das for√ßas.";
        if(!modo){
          setText("dataBiblica", `"${fallback}"`);
          setText("ref", "");
          return;
        }
        const res = await fetch(arq + "?ts=" + Date.now(), { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const j = await res.json();

        // modo biblico-anual: pega por dia do ano
        const arr = Array.isArray(j) ? j : (Array.isArray(j.versiculos) ? j.versiculos : []);
        if(!arr.length){
          setText("dataBiblica", `"${fallback}"`);
          setText("ref", "");
          return;
        }
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 0);
        const diff = now - start;
        const oneDay = 1000 * 60 * 60 * 24;
        const dayOfYear = Math.floor(diff / oneDay);
        const idx = Math.max(0, Math.min(arr.length-1, (dayOfYear-1) % arr.length));
        const item = arr[idx] || {};
        const txt = String(item.texto || item.text || fallback);
        const ref = String(item.referencia || item.ref || "");
        setText("dataBiblica", `"${txt}"`);
        setText("ref", ref ? `(${ref})` : "");
      }catch(e){
        const fallback = data?.temaDoDia?.fallback || "Deus √© fiel e n√£o permitir√° prova al√©m das for√ßas.";
        setText("dataBiblica", `"${fallback}"`);
        setText("ref", "");
      }
    }

    // Clima (placeholder: usa data.json se j√° vier pronto)
    async function carregarClima(data){
      const c = data?.clima || {};
      const cidade = c.cidade || "‚Äî";
      const temp = (c.temperatura != null) ? `${c.temperatura}¬∞C` : "‚Äî";
      const vento = (c.vento != null) ? `Vento ${c.vento} km/h` : "‚Äî";
      const chuva = (c.chuva != null) ? `Chuva ${c.chuva} mm` : "‚Äî";
      setText("cidadeClima", cidade);
      setText("tempClima", temp);
      setText("ventoClima", vento);
      setText("chuvaClima", chuva);
    }

    async function loadAll(){
      try{
        const data = await fetchDataJson();
        window.__lastDataForTopbar = data || {};
        updateStatus(true);

        // Topbar / t√≠tulos
        setText("titulo", data?.titulo || "Comunica S√≠ndico ‚Äî Cond√¥minos");
        setText("subtitulo", data?.subtitulo || "Painel informativo");
        setText("panelInfo", "Painel informativo");

        aplicarImagemTopbar(data);
        renderAvisos(data);
        await carregarVersiculo(data);
        await carregarClima(data);
        iniciarPublicidade(data);

        applyUrgentBox(data);
        await carregarMensagensCidade();
      }catch(e){
        updateStatus(false);
        try{ await carregarMensagensCidade(); }catch(_){}
      }
    }

    // Clique no Atualizar (r√°pido)
    document.getElementById("refPill")?.addEventListener("click", ()=>{
      loadAll();
    });

    // auto carregar
    loadAll();

    // auto refresh suave
    setInterval(()=>{ loadAll(); }, 60 * 1000);

    // PWA / Service Worker
    if ("serviceWorker" in navigator){
      window.addEventListener("load", async () => {
        try{
          const reg = await navigator.serviceWorker.register("./sw.js", { scope:"./" });
          try{ await reg.update(); }catch(e){}
          reg.addEventListener("updatefound", ()=>{
            const nw = reg.installing;
            if(!nw) return;
            nw.addEventListener("statechange", ()=>{
              if(nw.state === "installed" && navigator.serviceWorker.controller){
                nw.postMessage("SKIP_WAITING");
              }
            });
          });
        }catch(e){}
      });

      navigator.serviceWorker.addEventListener("controllerchange", ()=>{
        try{
          const b = document.getElementById("updateBanner");
          if(b) b.style.display = "block";
          setTimeout(()=>location.reload(), 1200);
        }catch(e){}
      });
    }
  </script>
</body>
</html>
