<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Admin ‚Äî Comunica S√≠ndico</title>

  <!-- PWA / MANIFEST (ADMIN) -->
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Admin" />

  <link rel="manifest" href="./manifest-admin.json" />

  <!-- √çcones (ADMIN) -->
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192x192.png" />

  <!-- Preview/compartilhamento (opcional) -->
  <meta property="og:title" content="Comunica S√≠ndico ‚Äî Admin" />
  <meta property="og:description" content="Painel Administrativo do S√≠ndico" />
  <meta property="og:image" content="./icons/icon-512x512.png" />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c1526;
      --line:rgba(255,255,255,.10);
      --muted:rgba(234,242,255,.72);
      --text:rgba(234,242,255,.96);
      --ok:#44d07a;
      --warn:#ffb347;
      --bad:#ff5a5a;
      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background: radial-gradient(1200px 700px at 20% 0%, #122b52 0%, var(--bg) 55%); color:var(--text); font-family:var(--sans); }
    a{ color:inherit; }
    .wrap{ min-height:100%; padding:16px; display:flex; justify-content:center; }
    .app{ width:min(1200px, 100%); display:grid; grid-template-columns: 430px 1fr; gap:14px; align-items:start; }
    @media (max-width: 980px){ .app{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(18,35,60,.92), rgba(12,22,40,.92));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.14);
    }
    .title{ font-weight:900; letter-spacing:.5px; }
    .sub{ font-size:12px; color:var(--muted); font-weight:800; margin-top:2px; }
    .body{ padding:14px; display:flex; flex-direction:column; gap:12px; }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:12px; font-weight:900; letter-spacing:.25px; color:rgba(234,242,255,.88); }

    input:not([type="checkbox"]), textarea, select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-weight:750;
    }
    textarea{ min-height:88px; resize:vertical; font-weight:650; line-height:1.25; }
    input::placeholder, textarea::placeholder{ color:rgba(234,242,255,.45); font-weight:650; }
    .mini{ font-size:12px; color:var(--muted); font-weight:800; line-height:1.25; }

    .btnRow{ display:flex; flex-wrap:wrap; gap:10px; }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      transition: transform .06s ease, filter .15s ease, opacity .15s ease;
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn:active{ transform:scale(.98); }
    .btn.ok{ background: rgba(68,208,122,.16); border-color: rgba(68,208,122,.40); }
    .btn.warn{ background: rgba(255,179,71,.14); border-color: rgba(255,179,71,.45); }
    .btn.bad{ background: rgba(255,90,90,.14); border-color: rgba(255,90,90,.55); }
    .btn.ghost{ background: transparent; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .pill{
      padding:6px 10px; border-radius:999px;
      font-weight:900; font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(68,208,122,.55); background: rgba(68,208,122,.16); color: rgba(234,242,255,.96); }
    .hr{ height:1px; background: rgba(255,255,255,.10); margin:4px 0; }

    .rememberRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
    }
    .rememberRow input[type="checkbox"]{
      width:18px !important;
      height:18px !important;
      padding:0 !important;
      margin:0 !important;
      background: transparent !important;
      border: none !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      appearance: auto !important;
      -webkit-appearance: auto !important;
      accent-color: var(--ok);
      cursor:pointer;
      pointer-events:auto;
      flex:0 0 auto;
    }
    .rememberRow span{ font-weight:900; opacity:.92; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(234,242,255,.90);
      padding:10px 12px;
      border-radius:999px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.22);
      color: rgba(234,242,255,.96);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
    }
    .tabSmall{ font-size:12px; font-weight:950; padding:8px 10px; }

    .panel{ display:none; }
    .panel.active{ display:block; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .item .col{ flex:1; display:flex; flex-direction:column; gap:8px; }
    .item .actions{ display:flex; flex-direction:column; gap:8px; }
    .chip{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(234,242,255,.86);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius:14px;
      word-break:break-word;
    }

    .code{
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      background: rgba(0,0,0,.32);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      white-space:pre;
      overflow:auto;
      max-height: 55vh;
    }

    .alertPreview{
      border-radius:18px;
      border:1px solid rgba(255,90,90,.60);
      background: linear-gradient(180deg, rgba(255,90,90,.22), rgba(80,0,0,.30));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), 0 18px 38px rgba(0,0,0,.45);
      padding:14px;
    }
    .alertPreview .aTitle{
      font-weight:1000;
      letter-spacing:.6px;
      text-transform:uppercase;
      font-size: clamp(18px, 2.1vw, 30px);
      color:#fff;
      margin:0 0 10px;
    }
    .alertPreview .aMsg{
      margin:0;
      font-weight:900;
      color:#fff;
      font-size: clamp(16px, 1.9vw, 28px);
      line-height:1.18;
      word-break:break-word;
    }

    .hint{
      font-size:12px;
      color:rgba(234,242,255,.70);
      font-weight:800;
      background: rgba(0,0,0,.20);
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 10px 12px;
      line-height: 1.3;
    }

    .overlay{
      position:fixed; inset:0;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(18,43,82,.92) 0%, rgba(11,18,32,.92) 55%);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .overlay.show{ display:flex; }
    .loginCard{
      width:min(520px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(18,35,60,.92), rgba(12,22,40,.92));
      box-shadow: 0 24px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .loginBody{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .bigTitle{ font-weight:1000; letter-spacing:.6px; font-size:18px; }
    .muted{ color:var(--muted); font-weight:850; font-size:12px; line-height:1.35; }
    .dangerSmall{ color: rgba(255,200,200,.92); font-weight:900; font-size:12px; }
    .imgPrev{
      width:100%; height:160px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .imgPrev img{ width:100%; height:100%; object-fit:cover; display:block; }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div class="overlay" id="loginOverlay">
    <div class="loginCard">
      <div class="head">
        <div>
          <div class="title">Acesso do S√≠ndico</div>
          <div class="sub">Senha simples (fica no navegador)</div>
        </div>
        <div class="pill" id="loginPill">Protegido</div>
      </div>
      <div class="loginBody">
        <div class="hint">
          üîí Esta prote√ß√£o √© <b>local</b> (client-side). <br/>
          Quem abrir este admin em outro navegador precisar√° definir/usar outra senha.
        </div>

        <div class="panel" id="panelCreatePass">
          <div class="bigTitle">Criar senha (primeiro acesso)</div>
          <div class="field">
            <label>Nova senha</label>
            <input id="newPass1" type="password" placeholder="Digite uma senha" />
          </div>
          <div class="field">
            <label>Confirmar senha</label>
            <input id="newPass2" type="password" placeholder="Repita a senha" />
          </div>
          <div class="btnRow">
            <button class="btn ok" id="btnCreatePass">‚úÖ Criar senha</button>
          </div>
          <div class="muted">Dica: depois voc√™ pode trocar a senha na aba <b>Config</b>.</div>
        </div>

        <div class="panel" id="panelEnterPass">
          <div class="bigTitle">Digite sua senha</div>
          <div class="field">
            <label>Senha</label>
            <input id="enterPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          <div class="btnRow">
            <button class="btn ok" id="btnEnterPass">üîì Entrar</button>
            <button class="btn bad" id="btnResetPass">üßπ Esqueci / Resetar</button>
          </div>
          <div class="dangerSmall" id="loginError" style="display:none">Senha inv√°lida.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="app">

      <!-- ESQUERDA: Admin -->
      <div class="card">
        <div class="head">
          <div>
            <div class="title">Admin (Discreto)</div>
            <div class="sub">Gerencia <b>Alerta</b>, <b>Avisos</b>, <b>V√≠deos</b> e <b>Cidade</b></div>
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <div class="pill ok" id="autoPill" style="display:none">AUTO</div>
            <div class="pill" id="statusPill">Offline</div>
          </div>
        </div>

        <div class="body">

          <div class="hint">
            ‚úÖ Fluxo: <b>Carregar</b> ‚Üí editar nas abas ‚Üí <b>Publicar no GitHub</b>. <br/>
            üîí Token do GitHub fica somente no navegador (sessionStorage) ou opcionalmente persistente (localStorage).
          </div>

          <div class="tabs" id="tabs">
            <button class="tab active" data-tab="tAlerta">üö® Alerta</button>
            <button class="tab" data-tab="tAvisos">üìå Avisos</button>
            <button class="tab" data-tab="tVideos">üé¨ V√≠deos</button>
            <button class="tab" data-tab="tCidade">üèôÔ∏è Cidade</button>
            <button class="tab tabSmall" data-tab="tConfig">‚öôÔ∏è Config</button>
          </div>

          <div class="hr"></div>

          <div class="panel active" id="tAlerta">
            <div class="field">
              <label>ALERTA URGENTE</label>
              <div class="row">
                <select id="fAlertAtivar">
                  <option value="false">Desligado (normal)</option>
                  <option value="true">Ligado (substitui Mensagens no Brasil)</option>
                </select>
                <select id="fAlertPiscar">
                  <option value="true">Piscar: Sim</option>
                  <option value="false">Piscar: N√£o</option>
                </select>
              </div>
              <input id="fAlertTitulo" placeholder="ALERTA URGENTE" />
              <textarea id="fAlertMsg" placeholder="Escreva a mensagem do alerta..."></textarea>

              <div class="btnRow">
                <button class="btn bad" id="btnAlertOn">üö® Ligar alerta</button>
                <button class="btn ok" id="btnAlertOff">‚úÖ Desligar alerta</button>
              </div>

              <div class="mini">Para ‚Äúvoltar tudo ao normal‚Äù: clique em <b>Desligar alerta</b> e publique.</div>
            </div>
          </div>

          <div class="panel" id="tAvisos">
            <div class="row">
              <div class="field">
                <label>Rota√ß√£o: intervalo (seg)</label>
                <input id="fRotInterval" type="number" min="3" max="60" step="1" />
              </div>
              <div class="field">
                <label>Qtd avisos (por tela)</label>
                <select id="fRotQtd">
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
              </div>
            </div>

            <div class="hr"></div>

            <div class="btnRow">
              <button class="btn ok" id="btnAddAviso">‚ûï Novo aviso</button>
              <button class="btn ghost" id="btnSortAvisos">‚ÜïÔ∏è Ordenar (mais novos primeiro)</button>
            </div>

            <div class="mini">
              Os avisos ficam em <b>avisos[]</b>. Voc√™ pode editar, reordenar e excluir aqui (sem mexer no JSON √† m√£o).
            </div>

            <div id="avisosList" class="list"></div>
          </div>

          <div class="panel" id="tVideos">
            <div class="field">
              <label>V√≠deos (Publicidades)</label>

              <!-- ‚úÖ NOVO: UPLOAD DIRETO PARA /ads -->
              <div class="hint" style="margin-top:6px">
                ‚¨ÜÔ∏è Envie um v√≠deo direto para <b>/ads</b> no GitHub e j√° copie/cole no campo <b>arquivo</b>.<br/>
                (Funciona melhor para v√≠deos menores; v√≠deos muito grandes podem falhar pela limita√ß√£o da API.)
              </div>
              <div class="row">
                <input id="adUploadFile" type="file" accept="video/*" />
                <button class="btn warn" id="btnUploadToAds">‚¨ÜÔ∏è Enviar para /ads</button>
              </div>
              <div class="mini" id="uploadStatus" style="margin-top:6px;opacity:.95">‚Äî</div>

              <div class="btnRow" style="margin-top:10px">
                <button class="btn ghost" id="btnAddVideo">‚ûï Incluir v√≠deo</button>
                <button class="btn ghost" id="btnShuffleToggle">üîÄ Alternar Shuffle</button>
              </div>
              <div class="mini">V√≠deos s√£o objetos em <b>publicidade.videos[]</b> (arquivo + anunciante).</div>
            </div>

            <div id="videosList" class="list"></div>
          </div>

          <div class="panel" id="tCidade">
            <div class="field">
              <label>T√≠tulo</label>
              <input id="fTitulo" placeholder="Comunica S√≠ndico ‚Äî Cond√¥minos" />
            </div>

            <div class="field">
              <label>Subt√≠tulo</label>
              <input id="fSubtitulo" placeholder="Painel Informativo" />
            </div>

            <div class="field">
              <label>Refer√™ncia (rodap√©)</label>
              <input id="fReferencia" placeholder="Atualizado automaticamente" />
            </div>

            <div class="hr"></div>

            <div class="field">
              <label>Cidade (Clima)</label>
              <input id="fCidade" placeholder="S√£o Paulo" />
              <div class="btnRow">
                <button class="btn ghost" id="btnBuscarCidade">üîé Buscar coordenadas</button>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label>Latitude</label>
                <input id="fLat" type="number" step="0.0001" />
              </div>
              <div class="field">
                <label>Longitude</label>
                <input id="fLon" type="number" step="0.0001" />
              </div>
            </div>

            <div class="field">
              <label>Timezone</label>
              <input id="fTz" placeholder="America/Sao_Paulo" />
            </div>

            <div class="hr"></div>

            <div class="field">
              <label>Cabe√ßalho ‚Äî Imagem da cidade</label>
              <div class="row">
                <select id="fCabAtivar">
                  <option value="false">Desligada</option>
                  <option value="true">Ligada</option>
                </select>
                <input id="fCabUrl" placeholder="../assets/cidade-header.jpg" />
              </div>

              <div class="imgPrev" id="imgPrev">
                <div class="mini" style="padding:10px">Pr√©via da imagem (ap√≥s enviar)</div>
              </div>

              <div class="btnRow">
                <input id="fileCab" type="file" accept="image/*" />
                <button class="btn warn" id="btnUploadCab">‚¨ÜÔ∏è Enviar imagem</button>
              </div>

              <div class="mini">
                ‚úÖ Voc√™ n√£o precisa colar URL: o bot√£o <b>Enviar imagem</b> sobe a foto para o GitHub em
                <b>assets/cidade-header.jpg</b> e preenche automaticamente o campo acima.
              </div>
            </div>
          </div>

          <div class="panel" id="tConfig">
            <div class="field">
              <label>Token do GitHub (PAT com permiss√£o repo)</label>
              <input id="token" type="password" placeholder="ghp_..." />

              <label class="rememberRow" for="rememberToken">
                <input type="checkbox" id="rememberToken" />
                <span>Lembrar token neste navegador (menos seguro)</span>
              </label>

              <label class="rememberRow" for="autoCarregar">
                <input type="checkbox" id="autoCarregar" />
                <span>Autocarregar data.json ao abrir</span>
              </label>

              <div class="mini" id="autoLoadStatus" style="margin-top:6px;opacity:.95">
                Autocarregar: <b>desligado</b>
              </div>

              <div class="mini">Cole aqui, clique em <b>Salvar token</b>, depois <b>Publicar</b>.</div>
              <div class="btnRow">
                <button class="btn ghost" id="btnSaveToken">üíæ Salvar token</button>
                <button class="btn ghost" id="btnClearToken">üßπ Limpar token</button>
                <button class="btn ghost" id="btnOpenPanel">üì£ Abrir Cond√¥minos</button>
                <button class="btn ghost" id="btnOpenSindico">üè¢ Abrir S√≠ndico</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="btnRow">
              <button class="btn ok" id="btnLoad">‚ü≥ Carregar data.json</button>
              <button class="btn warn" id="btnDownload">‚¨áÔ∏è Baixar data.json</button>
              <button class="btn bad" id="btnPublish">üöÄ Publicar no GitHub</button>
            </div>

            <div class="hr"></div>

            <div class="field">
              <label>Senha do Admin</label>
              <div class="mini">Troca local (fica neste navegador).</div>
              <div class="row">
                <input id="oldPass" type="password" placeholder="Senha atual" />
                <input id="newPass" type="password" placeholder="Nova senha" />
              </div>
              <div class="btnRow">
                <button class="btn ok" id="btnChangePass">üîÅ Trocar senha</button>
                <button class="btn bad" id="btnLogout">üö™ Sair</button>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="head">
          <div>
            <div class="title">Pr√©via & JSON</div>
            <div class="sub">Veja como ficar√° o alerta e o <b>data.json</b> final</div>
          </div>
          <div class="pill" id="pillRepo">comunicasindico/comunica-sindico</div>
        </div>

        <div class="body">
          <div class="btnRow">
            <button class="btn ghost" id="btnRebuild">üß© Regerar JSON</button>
            <button class="btn ghost" id="btnCopyJson">üìã Copiar JSON</button>
          </div>

          <div id="alertPreviewWrap" style="display:none">
            <div class="alertPreview" id="alertPreview">
              <p class="aTitle" id="pAlertTitle">ALERTA URGENTE</p>
              <p class="aMsg" id="pAlertMsg">‚Äî</p>
            </div>
          </div>

          <div class="code" id="jsonView">Carregue o data.json para come√ßar‚Ä¶</div>
        </div>
      </div>

    </div>
  </div>

<script>
/* ============================
   CONFIG DO REPO
   ============================ */
const GITHUB_OWNER  = "comunicasindico";
const GITHUB_REPO   = "comunica-sindico";
const GITHUB_BRANCH = "main";
const GITHUB_PATH   = "data.json";

/* Upload da imagem do cabe√ßalho (caminho fixo) */
const GITHUB_CAB_PATH = "assets/cidade-header.jpg";
const CAB_PUBLIC_URL  = "../assets/cidade-header.jpg";

/* ‚úÖ Upload de v√≠deos (ads/) */
const GITHUB_ADS_DIR = "ads";

/* ============================
   ESTADO
   ============================ */
let DATA = null;
let DATA_ORIGINAL = null;

const $ = (id)=>document.getElementById(id);
const statusPill = $("statusPill");
const autoPill   = $("autoPill");

function setAutoBadge(show){
  if(!autoPill) return;
  autoPill.style.display = show ? "inline-flex" : "none";
}

function setStatus(text, type){
  statusPill.textContent = text;
  statusPill.style.borderColor =
    type==="ok" ? "rgba(68,208,122,.55)" :
    type==="bad" ? "rgba(255,90,90,.65)" :
    "rgba(255,255,255,.12)";
  statusPill.style.background =
    type==="ok" ? "rgba(68,208,122,.16)" :
    type==="bad" ? "rgba(255,90,90,.14)" :
    "rgba(0,0,0,.18)";
  statusPill.style.color = type==="ok" ? "rgba(234,242,255,.96)" : "rgba(234,242,255,.85)";
}

function safeClone(obj){ return JSON.parse(JSON.stringify(obj ?? null)); }
function prettyJson(obj){ return JSON.stringify(obj, null, 2); }

  /* ============================
   LIMPAR AVISOS EXPIRADOS (campo "fim")
   ============================ */
function removerAvisosExpirados(){

  if(!DATA || !Array.isArray(DATA.avisos)) return;

  DATA.avisos = DATA.avisos.filter(aviso => {

    if(!aviso.fim) return true;

    try{
      const [dataStr, horaStr] = aviso.fim.split("-").map(p => p.trim());
      const [dia, mes, ano] = dataStr.split("/").map(n => parseInt(n.trim()));
      const [hora, minuto]  = horaStr.split(":").map(n => parseInt(n.trim()));

      const anoCompleto = ano < 100 ? 2000 + ano : ano;

      const dataFim = new Date(
        anoCompleto,
        mes - 1,
        dia,
        hora,
        minuto,
        0
      );

      return Date.now() <= dataFim.getTime();

    }catch(e){
      return true;
    }

  });

}

  /* ============================
   VERIFICA SE AVISO EST√Å VENCIDO
   ============================ */
function avisoEstaVencido(aviso){

  if(!aviso.fim) return false;

  try{
    const [dataStr, horaStr] = aviso.fim.split("-").map(p => p.trim());
    const [dia, mes, ano] = dataStr.split("/").map(n => parseInt(n.trim()));
    const [hora, minuto]  = horaStr.split(":").map(n => parseInt(n.trim()));

    const anoCompleto = ano < 100 ? 2000 + ano : ano;

    const dataFim = new Date(
      anoCompleto,
      mes - 1,
      dia,
      hora,
      minuto,
      0
    );

    return Date.now() > dataFim.getTime();

  }catch(e){
    return false;
  }
}

  
/* ============================
   LOGIN (senha local)
   ‚úÖ AJUSTE: sempre pedir senha ao abrir (sess√£o n√£o persiste)
   ============================ */
const PASS_KEY = "CS_ADMIN_PASS_HASH";
const AUTH_KEY = "CS_ADMIN_AUTH_OK"; // sess√£o (n√£o persiste) + vamos limpar no init

async function sha256Hex(str){
  const data = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest("SHA-256", data);
  const bytes = Array.from(new Uint8Array(hash));
  return bytes.map(b=>b.toString(16).padStart(2,"0")).join("");
}
function getPassHash(){
  try{ return (localStorage.getItem(PASS_KEY)||"").trim(); }catch(e){ return ""; }
}
function setPassHash(v){
  try{ localStorage.setItem(PASS_KEY, v); }catch(e){}
}
function setAuth(ok){
  try{
    if(ok) sessionStorage.setItem(AUTH_KEY,"1");
    else sessionStorage.removeItem(AUTH_KEY);
  }catch(e){}
}
function isAuthed(){
  try{ return sessionStorage.getItem(AUTH_KEY)==="1"; }catch(e){ return false; }
}
function showLogin(){
  const ov = $("loginOverlay");
  ov.classList.add("show");

  const hasPass = !!getPassHash();
  $("panelCreatePass").style.display = hasPass ? "none" : "block";
  $("panelEnterPass").style.display  = hasPass ? "block" : "none";
  $("loginError").style.display = "none";

  $("loginPill").textContent = hasPass ? "Protegido" : "Criar senha";
}
function hideLogin(){
  $("loginOverlay").classList.remove("show");
}

async function handleCreatePass(){
  const p1 = ($("newPass1").value||"").trim();
  const p2 = ($("newPass2").value||"").trim();
  if(p1.length < 4){ alert("Use uma senha com pelo menos 4 caracteres."); return; }
  if(p1 !== p2){ alert("As senhas n√£o conferem."); return; }

  const h = await sha256Hex(p1);
  setPassHash(h);
  setAuth(true);

  $("newPass1").value = "";
  $("newPass2").value = "";

  hideLogin();
  await maybeAutoCarregar();
  alert("‚úÖ Senha criada. Voc√™ j√° est√° logado.");
}

async function handleEnterPass(){
  const p = ($("enterPass").value||"").trim();
  const h = await sha256Hex(p);
  const ok = (h === getPassHash());
  if(!ok){
    $("loginError").style.display = "block";
    $("enterPass").value = "";
    return;
  }
  setAuth(true);
  $("enterPass").value = "";
  hideLogin();
  await maybeAutoCarregar();
}

function handleResetPass(){
  if(!confirm("Resetar a senha local deste navegador?")) return;
  try{ localStorage.removeItem(PASS_KEY); }catch(e){}
  setAuth(false);
  $("enterPass").value = "";
  showLogin();
}

async function handleChangePass(){
  const oldP = ($("oldPass").value||"").trim();
  const newP = ($("newPass").value||"").trim();
  if(newP.length < 4){ alert("Nova senha precisa ter pelo menos 4 caracteres."); return; }

  const curHash = getPassHash();
  if(curHash){
    const oldH = await sha256Hex(oldP);
    if(oldH !== curHash){ alert("Senha atual incorreta."); return; }
  }
  const newH = await sha256Hex(newP);
  setPassHash(newH);
  // üîê Seguran√ßa: limpa token ao trocar senha
try{
  localStorage.removeItem(GH_TOKEN_LOCAL_KEY);
  sessionStorage.removeItem(GH_TOKEN_SESSION_KEY);
}catch(e){}

  $("oldPass").value = "";
  $("newPass").value = "";
  alert("‚úÖ Senha alterada neste navegador.");
}

function logout(){
  setAuth(false);
  showLogin();
}

/* ============================
   TOKEN (sess√£o + lembrar)
   ‚úÖ mant√©m token para n√£o pedir toda hora
   ============================ */
const GH_TOKEN_SESSION_KEY = "CS_GH_TOKEN_SESSION";
const GH_TOKEN_LOCAL_KEY   = "CS_GH_TOKEN_LOCAL";

function getToken(){
  try{
    // prioridade: localStorage persistente
    const local = (localStorage.getItem(GH_TOKEN_LOCAL_KEY) || "").trim();
    if(local) return local;

    // fallback session
    const sess = (sessionStorage.getItem(GH_TOKEN_SESSION_KEY) || "").trim();
    if(sess) return sess;

    // fallback campo digitado
    const input = ($("token").value || "").trim();
    return input || "";

  }catch(e){
    return "";
  }
}


function saveToken(){
  const v = ($("token").value || "").trim();
  if(!v){ alert("Cole seu token primeiro."); return; }

  try{
    // salvar permanente
    localStorage.setItem(GH_TOKEN_LOCAL_KEY, v);
    sessionStorage.setItem(GH_TOKEN_SESSION_KEY, v);
  }catch(e){}

  $("token").value = "";
  alert("‚úÖ Token salvo permanentemente neste navegador.");
}


function clearToken(){
  try{ sessionStorage.removeItem(GH_TOKEN_SESSION_KEY); }catch(e){}
  try{ localStorage.removeItem(GH_TOKEN_LOCAL_KEY); }catch(e){}
  $("token").value = "";
  if($("rememberToken")) $("rememberToken").checked = false;
  alert("Token removido deste navegador.");
}

function initTokenUI(){
  try{
    const saved = (localStorage.getItem(GH_TOKEN_LOCAL_KEY)||"").trim();
    if(saved){
      sessionStorage.setItem(GH_TOKEN_SESSION_KEY, saved);
      $("token").value = saved; // apenas visual
    }
  }catch(e){}
}


/* ============================
   AUTOCARREGAR
   ============================ */
const AUTOLOAD_KEY = "CS_ADMIN_AUTOLOAD";

function setAutoLoadStatus(text, type){
  const el = $("autoLoadStatus");
  if(!el) return;

  const color =
    type==="ok"   ? "rgba(68,208,122,.95)" :
    type==="warn" ? "rgba(255,179,71,.95)" :
    type==="bad"  ? "rgba(255,90,90,.95)" :
    "rgba(234,242,255,.78)";

  el.innerHTML = text;
  el.style.color = color;
}

function getAutoCarregar(){
  try{ return localStorage.getItem(AUTOLOAD_KEY) === "1"; }
  catch(e){ return false; }
}

function setAutoCarregar(v){
  try{ localStorage.setItem(AUTOLOAD_KEY, v ? "1" : "0"); }
  catch(e){}
}

function applyAutoCarregarUI(){
  const cb = $("autoCarregar");
  if(cb) cb.checked = getAutoCarregar();
  setAutoLoadStatus(`Autocarregar: <b>${getAutoCarregar() ? "ligado" : "desligado"}</b>`, getAutoCarregar() ? "ok" : "");
}

function bindAutoCarregar(){
  const cb = $("autoCarregar");
  if(!cb) return;

  cb.addEventListener("click", (e)=> e.stopPropagation());
  cb.addEventListener("change", ()=>{
    setAutoCarregar(!!cb.checked);
    applyAutoCarregarUI();
  });
}

async function maybeAutoCarregar(){
  if(getAutoCarregar()){
    await loadData("auto");
  }
}

/* ============================
   BASE SHAPE
   ============================ */
function ensureBaseShape(){
  if(!DATA) DATA = {};

  DATA.condominio = DATA.condominio ?? "Comunica S√≠ndico";
  DATA.titulo = DATA.titulo ?? "Comunica S√≠ndico ‚Äî Cond√¥minos";
  DATA.subtitulo = DATA.subtitulo ?? "Painel Informativo";
  DATA.referencia = DATA.referencia ?? "Atualizado automaticamente";

  DATA.rotacao = DATA.rotacao ?? {};
  DATA.rotacao.ativar = (DATA.rotacao.ativar ?? true);
  DATA.rotacao.intervaloSeg = Number(DATA.rotacao.intervaloSeg ?? 8);
  DATA.rotacao.quantidadePorTela = Number(DATA.rotacao.quantidadePorTela ?? 3);
  DATA.rotacao.mostrarProgresso = (DATA.rotacao.mostrarProgresso ?? true);
  DATA.rotacao.pausarNoMouse = (DATA.rotacao.pausarNoMouse ?? false);

  DATA.clima = DATA.clima ?? {};
  DATA.clima.cidade = DATA.clima.cidade ?? "S√£o Paulo";
  DATA.clima.latitude = Number(DATA.clima.latitude ?? -23.5505);
  DATA.clima.longitude = Number(DATA.clima.longitude ?? -46.6333);
  DATA.clima.timezone = DATA.clima.timezone ?? "America/Sao_Paulo";

  DATA.publicidade = DATA.publicidade ?? {};
  DATA.publicidade.ativar = (DATA.publicidade.ativar ?? true);
  DATA.publicidade.shuffle = (DATA.publicidade.shuffle ?? true);
  DATA.publicidade.cidadeTitulo = DATA.publicidade.cidadeTitulo ?? "Mensagens no Brasil";

  DATA.publicidade.cabecalhoImagem = DATA.publicidade.cabecalhoImagem ?? { ativar:false, url:"" };
  DATA.publicidade.cabecalhoImagem.ativar = !!DATA.publicidade.cabecalhoImagem.ativar;
  DATA.publicidade.cabecalhoImagem.url = String(DATA.publicidade.cabecalhoImagem.url ?? "");

  DATA.publicidade.videos = Array.isArray(DATA.publicidade.videos) ? DATA.publicidade.videos : [];

  DATA.alertaUrgente = DATA.alertaUrgente ?? { ativar:false, titulo:"ALERTA URGENTE", mensagem:"", piscar:true };
  DATA.alertaUrgente.ativar = !!DATA.alertaUrgente.ativar;
  DATA.alertaUrgente.titulo = String(DATA.alertaUrgente.titulo ?? "ALERTA URGENTE");
  DATA.alertaUrgente.mensagem = String(DATA.alertaUrgente.mensagem ?? "");
  DATA.alertaUrgente.piscar = (DATA.alertaUrgente.piscar ?? true);

  DATA.avisos = Array.isArray(DATA.avisos) ? DATA.avisos : [];
  DATA.avisos.forEach(a=>{
    a.id = a.id ?? ("a_" + Math.random().toString(16).slice(2) + "_" + Date.now());
    a.titulo = String(a.titulo ?? "");
    a.descricao = String(a.descricao ?? a.msg ?? "");
    delete a.msg;
    a.nivel = String(a.nivel ?? "MEDIA").toUpperCase();
    if(!["BAIXA","MEDIA","ALTA"].includes(a.nivel)) a.nivel = "MEDIA";
    a.ativo = (a.ativo ?? true);
    a.criadoEm = a.criadoEm ?? new Date().toISOString();
  });
}

/* ============================
   LOAD data.json (agora √© ../data.json)
   ============================ */
async function loadData(origin){
  const mode = origin === "auto" ? "Autocarregando‚Ä¶" : "Carregando‚Ä¶";
  setStatus(mode,"");
  setAutoBadge(false);

  try{
    const res = await fetch("../data.json?ts=" + Date.now(), { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const ct = (res.headers.get("content-type")||"").toLowerCase();
    if(!ct.includes("application/json")) throw new Error("Resposta n√£o-JSON: " + ct);

    const j = await res.json();
    DATA = j;
    DATA_ORIGINAL = safeClone(j);

    fillFormFromData();
    rebuildJsonView();

    setStatus("Atualizado","ok");

    if(origin === "auto"){
      setAutoBadge(true);
      setAutoLoadStatus(`‚úÖ Autocarregar: <b>data.json carregado automaticamente</b>`, "ok");
    }else{
      setAutoBadge(false);
      setAutoLoadStatus(`‚ÑπÔ∏è Autocarregar: <b>carregado manualmente</b>`, "warn");
    }
  }catch(e){
    console.error(e);
    setStatus("Offline","bad");
    setAutoBadge(false);
    setAutoLoadStatus(`‚ùå Autocarregar: <b>falhou (offline)</b>`, "bad");
    alert("N√£o consegui carregar ../data.json. Confirme se o arquivo existe na raiz.");
  }
}

/* ============================
   FORM <-> DATA
   ============================ */
function fillFormFromData(){
  ensureBaseShape();

  $("fTitulo").value = DATA.titulo || "";
  $("fSubtitulo").value = DATA.subtitulo || "";
  $("fReferencia").value = DATA.referencia || "";

  $("fRotInterval").value = Number(DATA.rotacao.intervaloSeg || 8);
  $("fRotQtd").value = String(Number(DATA.rotacao.quantidadePorTela || 3));

  $("fCidade").value = DATA.clima.cidade || "";
  $("fLat").value = Number(DATA.clima.latitude || 0);
  $("fLon").value = Number(DATA.clima.longitude || 0);
  $("fTz").value = DATA.clima.timezone || "America/Sao_Paulo";

  $("fCabAtivar").value = String(!!DATA.publicidade.cabecalhoImagem.ativar);
  $("fCabUrl").value = DATA.publicidade.cabecalhoImagem.url || "";

  renderCabPreview();

  $("fAlertAtivar").value = String(!!DATA.alertaUrgente.ativar);
  $("fAlertPiscar").value = String(!!DATA.alertaUrgente.piscar);
  $("fAlertTitulo").value = DATA.alertaUrgente.titulo || "ALERTA URGENTE";
  $("fAlertMsg").value = DATA.alertaUrgente.mensagem || "";

  renderAvisos();
  renderVideos();
  renderAlertPreview();
}

function applyFormToData(){
  ensureBaseShape();

  DATA.titulo = $("fTitulo").value.trim() || DATA.titulo;
  DATA.subtitulo = $("fSubtitulo").value.trim() || DATA.subtitulo;
  DATA.referencia = $("fReferencia").value.trim() || DATA.referencia;

  DATA.rotacao.intervaloSeg = Math.max(3, Math.min(60, Number($("fRotInterval").value || 8)));
  DATA.rotacao.quantidadePorTela = Number($("fRotQtd").value || 3);

  DATA.clima.cidade = $("fCidade").value.trim() || DATA.clima.cidade;
  DATA.clima.latitude = Number($("fLat").value || DATA.clima.latitude);
  DATA.clima.longitude = Number($("fLon").value || DATA.clima.longitude);
  DATA.clima.timezone = $("fTz").value.trim() || DATA.clima.timezone;

  DATA.publicidade.cabecalhoImagem.ativar = ($("fCabAtivar").value === "true");
  DATA.publicidade.cabecalhoImagem.url = $("fCabUrl").value.trim();

  DATA.alertaUrgente.ativar = ($("fAlertAtivar").value === "true");
  DATA.alertaUrgente.piscar = ($("fAlertPiscar").value === "true");
  DATA.alertaUrgente.titulo = $("fAlertTitulo").value.trim() || "ALERTA URGENTE";
  DATA.alertaUrgente.mensagem = $("fAlertMsg").value.trim();

  renderAlertPreview();
}

function rebuildJsonView(){
  if(!DATA){ $("jsonView").textContent = "Carregue o data.json para come√ßar‚Ä¶"; return; }
  applyFormToData();
  $("jsonView").textContent = prettyJson(DATA);
}

/* ============================
   TABS
   ============================ */
function setTab(tabId){
  document.querySelectorAll(".tab").forEach(b=>{
    b.classList.toggle("active", b.dataset.tab === tabId);
  });
  document.querySelectorAll(".panel").forEach(p=>{
    p.classList.toggle("active", p.id === tabId);
  });
}

/* ============================
   ALERTA PREVIEW
   ============================ */
function renderAlertPreview(){
  if(!DATA) return;
  const on = !!DATA.alertaUrgente?.ativar;
  $("alertPreviewWrap").style.display = on ? "block" : "none";
  $("pAlertTitle").textContent = DATA.alertaUrgente?.titulo || "ALERTA URGENTE";
  $("pAlertMsg").textContent = DATA.alertaUrgente?.mensagem || "‚Äî";

  const blink = !!DATA.alertaUrgente?.piscar;
  $("alertPreview").style.animation = (on && blink) ? "blink 0.9s ease-in-out infinite" : "none";
}
(function injectBlink(){
  const st = document.createElement("style");
  st.textContent = `
    @keyframes blink{
      0%,100%{ filter:brightness(1); transform: translateY(0); }
      50%{ filter:brightness(1.18); transform: translateY(-1px); }
    }
  `;
  document.head.appendChild(st);
})();

/* ============================
   AVISOS CRUD
   ============================ */
function renderAvisos(){
  ensureBaseShape();
  const list = $("avisosList");
  if(!list) return;
  list.innerHTML = "";

  if(!DATA.avisos.length){
    const d = document.createElement("div");
    d.className = "hint";
    d.innerHTML = "Nenhum aviso cadastrado em <b>avisos[]</b>.";
    list.appendChild(d);
    return;
  }

  DATA.avisos.forEach((a, idx)=>{
   const wrap = document.createElement("div");
wrap.className = "item";

if(avisoEstaVencido(a)){
  wrap.style.border = "2px solid rgba(255,90,90,.75)";
  wrap.style.background = "linear-gradient(180deg, rgba(255,0,0,.18), rgba(40,0,0,.35))";
}

    const col = document.createElement("div");
    col.className = "col";

    const chip = document.createElement("div");
    chip.className = "chip";
   
    const vencido = avisoEstaVencido(a);
    chip.textContent =
      `#${idx+1}  ${a.nivel}  ‚Ä¢  ${a.ativo ? "ATIVO" : "INATIVO"}`
      + (vencido ? "  ‚Ä¢  VENCIDO" : "")
      + `  ‚Ä¢  id: ${a.id}`;
    if(vencido){
      chip.style.color = "rgba(255,200,200,.95)";
      chip.style.borderColor = "rgba(255,90,90,.55)";
    }    

    col.appendChild(chip);

    const row1 = document.createElement("div");
    row1.className = "row";

    const inpTit = document.createElement("input");
    inpTit.placeholder = "T√≠tulo do aviso";
    inpTit.value = String(a.titulo || "");
    inpTit.oninput = ()=>{ a.titulo = inpTit.value; rebuildJsonView(); };

    const selNivel = document.createElement("select");
    ["BAIXA","MEDIA","ALTA"].forEach(n=>{
      const opt = document.createElement("option");
      opt.value = n; opt.textContent = n;
      if(String(a.nivel||"MEDIA").toUpperCase()===n) opt.selected = true;
      selNivel.appendChild(opt);
    });
    selNivel.onchange = ()=>{ a.nivel = selNivel.value; rebuildJsonView(); };

    row1.appendChild(inpTit);
    row1.appendChild(selNivel);

    const txtDesc = document.createElement("textarea");
    txtDesc.placeholder = "Descri√ß√£o do aviso (texto completo)";
    txtDesc.value = String(a.descricao || "");
    txtDesc.oninput = ()=>{ a.descricao = txtDesc.value; rebuildJsonView(); };

    const row2 = document.createElement("div");
    row2.className = "row";

    const selAtivo = document.createElement("select");
    selAtivo.innerHTML = `
      <option value="true">Ativo</option>
      <option value="false">Inativo</option>
    `;
    selAtivo.value = String(!!a.ativo);
    selAtivo.onchange = ()=>{ a.ativo = (selAtivo.value==="true"); rebuildJsonView(); };

    const inpCriado = document.createElement("input");
    inpCriado.placeholder = "criadoEm (ISO)";
    inpCriado.value = String(a.criadoEm || "");
    inpCriado.oninput = ()=>{ a.criadoEm = inpCriado.value.trim(); rebuildJsonView(); };

    const inpFim = document.createElement("input");
    inpFim.placeholder = "fim (DD/MM/AA - HH:MM)";
    inpFim.value = String(a.fim || "");
    inpFim.oninput = ()=>{
      a.fim = inpFim.value.trim();
      rebuildJsonView();
    };

row2.appendChild(inpFim);


    row2.appendChild(selAtivo);
    row2.appendChild(inpCriado);

    col.appendChild(row1);
    col.appendChild(txtDesc);
    col.appendChild(row2);

    const actions = document.createElement("div");
    actions.className = "actions";

    const up = document.createElement("button");
    up.className = "btn ghost";
    up.textContent = "‚¨ÜÔ∏è";
    up.title = "Subir";
    up.onclick = ()=>{
      if(idx<=0) return;
      const arr = DATA.avisos;
      [arr[idx-1], arr[idx]] = [arr[idx], arr[idx-1]];
      renderAvisos();
      rebuildJsonView();
    };

    const down = document.createElement("button");
    down.className = "btn ghost";
    down.textContent = "‚¨áÔ∏è";
    down.title = "Descer";
    down.onclick = ()=>{
      const arr = DATA.avisos;
      if(idx>=arr.length-1) return;
      [arr[idx+1], arr[idx]] = [arr[idx], arr[idx+1]];
      renderAvisos();
      rebuildJsonView();
    };

    const del = document.createElement("button");
    del.className = "btn bad";
    del.textContent = "üóëÔ∏è";
    del.title = "Excluir";
    del.onclick = ()=>{
      if(!confirm("Excluir este aviso?")) return;
      DATA.avisos.splice(idx,1);
      renderAvisos();
      rebuildJsonView();
    };

    actions.appendChild(up);
    actions.appendChild(down);
    actions.appendChild(del);

    wrap.appendChild(col);
    wrap.appendChild(actions);
    list.appendChild(wrap);
  });
}

function addAviso(){
  ensureBaseShape();
  const now = new Date().toISOString();
  DATA.avisos.unshift({
    id: "a_" + Math.random().toString(16).slice(2) + "_" + Date.now(),
    titulo: "Novo aviso",
    descricao: "Digite a descri√ß√£o aqui‚Ä¶",
    nivel: "MEDIA",
    ativo: true,
    criadoEm: now
  });
  renderAvisos();
  rebuildJsonView();
}

function sortAvisos(){
  ensureBaseShape();
  DATA.avisos.sort((a,b)=>{
    const ta = Date.parse(a.criadoEm||"") || 0;
    const tb = Date.parse(b.criadoEm||"") || 0;
    return tb - ta;
  });
  renderAvisos();
  rebuildJsonView();
}

/* ============================
   V√çDEOS CRUD
   ============================ */
function renderVideos(){
  ensureBaseShape();
  const list = $("videosList");
  list.innerHTML = "";

  if(!DATA.publicidade.videos.length){
    const d = document.createElement("div");
    d.className = "hint";
    d.innerHTML = "Nenhum v√≠deo cadastrado em <b>publicidade.videos</b>.";
    list.appendChild(d);
    return;
  }

  DATA.publicidade.videos.forEach((v, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "item";

    const col = document.createElement("div");
    col.className = "col";

    const inpFile = document.createElement("input");
    inpFile.placeholder = "./ads/seu_video.mp4";
    inpFile.value = String(v.arquivo || "");
    inpFile.oninput = ()=>{ v.arquivo = inpFile.value.trim(); rebuildJsonView(); };

    const inpAdv = document.createElement("input");
    inpAdv.placeholder = "Anunciante / texto";
    inpAdv.value = String(v.anunciante || "");
    inpAdv.oninput = ()=>{ v.anunciante = inpAdv.value.trim(); rebuildJsonView(); };

    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = `#${idx+1}  arquivo: ${String(v.arquivo||"‚Äî")}`;

    col.appendChild(chip);
    col.appendChild(inpFile);
    col.appendChild(inpAdv);

    const actions = document.createElement("div");
    actions.className = "actions";

    const up = document.createElement("button");
    up.className = "btn ghost";
    up.textContent = "‚¨ÜÔ∏è";
    up.title = "Subir";
    up.onclick = ()=>{
      if(idx<=0) return;
      const a = DATA.publicidade.videos;
      [a[idx-1], a[idx]] = [a[idx], a[idx-1]];
      renderVideos();
      rebuildJsonView();
    };

    const down = document.createElement("button");
    down.className = "btn ghost";
    down.textContent = "‚¨áÔ∏è";
    down.title = "Descer";
    down.onclick = ()=>{
      const a = DATA.publicidade.videos;
      if(idx>=a.length-1) return;
      [a[idx+1], a[idx]] = [a[idx], a[idx+1]];
      renderVideos();
      rebuildJsonView();
    };

    const del = document.createElement("button");
    del.className = "btn bad";
    del.textContent = "üóëÔ∏è";
    del.title = "Excluir";
    del.onclick = ()=>{
      if(!confirm("Excluir este v√≠deo?")) return;
      DATA.publicidade.videos.splice(idx,1);
      renderVideos();
      rebuildJsonView();
    };

    actions.appendChild(up);
    actions.appendChild(down);
    actions.appendChild(del);

    wrap.appendChild(col);
    wrap.appendChild(actions);
    list.appendChild(wrap);
  });
}

function addVideo(){
  ensureBaseShape();
  DATA.publicidade.videos.push({ arquivo:"./ads/novo.mp4", anunciante:"Novo v√≠deo" });
  renderVideos();
  rebuildJsonView();
}

function toggleShuffle(){
  ensureBaseShape();
  DATA.publicidade.shuffle = !DATA.publicidade.shuffle;
  alert("Shuffle agora est√°: " + (DATA.publicidade.shuffle ? "LIGADO" : "DESLIGADO"));
  rebuildJsonView();
}

/* ============================
   CIDADE (OPEN-METEO GEO)
   ============================ */
async function buscarCidade(){
  const name = ($("fCidade").value||"").trim();
  if(!name){ alert("Digite o nome da cidade."); return; }

  try{
    setStatus("Buscando cidade‚Ä¶","");
    const url = "https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(name) + "&count=5&language=pt&format=json";
    const res = await fetch(url, { cache:"no-store" });
    const j = await res.json();
    const arr = Array.isArray(j?.results) ? j.results : [];
    if(!arr.length) throw new Error("Sem resultados");

    const r = arr[0];
    $("fLat").value = Number(r.latitude || 0);
    $("fLon").value = Number(r.longitude || 0);
    if(r.timezone) $("fTz").value = r.timezone;

    const nice = [r.name, r.admin1, r.country].filter(Boolean).join(" - ");
    $("fCidade").value = nice || name;

    rebuildJsonView();
    setStatus("Atualizado","ok");
    alert("Cidade aplicada:\n" + (nice || name));
  }catch(e){
    console.error(e);
    setStatus("Offline","bad");
    alert("N√£o consegui buscar coordenadas agora. Voc√™ pode preencher lat/lon manualmente.");
  }
}

/* ============================
   DOWNLOAD / COPY
   ============================ */
function downloadJson(){
  if(!DATA){ alert("Carregue o data.json primeiro."); return; }
  rebuildJsonView();
  const blob = new Blob([prettyJson(DATA)], { type:"application/json;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "data.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
}

async function copyJson(){
  if(!DATA){ alert("Carregue o data.json primeiro."); return; }
  rebuildJsonView();
  try{
    await navigator.clipboard.writeText(prettyJson(DATA));
    alert("JSON copiado.");
  }catch(e){
    alert("N√£o consegui copiar automaticamente. Selecione o texto no painel e copie manualmente.");
  }
}

/* ============================
   GitHub API (Contents)
   ============================ */
function b64EncodeUnicode(str){
  return btoa(unescape(encodeURIComponent(str)));
}

async function ghGetShaForPath(token, path){
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(GITHUB_BRANCH)}`;
  const res = await fetch(url, {
    headers:{
      "Authorization":"Bearer " + token,
      "Accept":"application/vnd.github+json"
    }
  });
  if(res.status === 404) return null;
  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error("GitHub GET sha falhou: " + res.status + " " + txt);
  }
  const j = await res.json();
  return j?.sha || null;
}

async function ghPutFileRaw(token, path, contentBase64, sha, message){
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}`;
  const body = {
    message: message || ("Atualizar " + path + " via Admin"),
    content: contentBase64,
    branch: GITHUB_BRANCH
  };
  if(sha) body.sha = sha;

  const res = await fetch(url, {
    method:"PUT",
    headers:{
      "Authorization":"Bearer " + token,
      "Accept":"application/vnd.github+json",
      "Content-Type":"application/json"
    },
    body: JSON.stringify(body)
  });

  if(!res.ok){
    let payload = "";
    try{
      const j = await res.json();
      payload = JSON.stringify(j, null, 2);
    }catch(_){
      payload = await res.text().catch(()=> "");
    }
    throw new Error("GitHub PUT falhou: " + res.status + "\n" + payload);
  }

  return await res.json();
}

async function publishToGitHub(){
  if(!DATA){ alert("Carregue o data.json primeiro."); return; }

  const token = getToken();
  if(!token){
    alert("Cole seu token e clique em 'Salvar token'.");
    return;
  }

  rebuildJsonView();

/* üî• LIMPA AVISOS VENCIDOS ANTES DE PUBLICAR */
removerAvisosExpirados();

const contentStr = prettyJson(DATA);


  try{
    setStatus("Publicando‚Ä¶","");
    const sha = await ghGetShaForPath(token, GITHUB_PATH);
    await ghPutFileRaw(token, GITHUB_PATH, b64EncodeUnicode(contentStr), sha, "Atualizar data.json via Admin");
    setStatus("Publicado!","ok");
    alert("‚úÖ Publicado no GitHub!\nAguarde alguns segundos e atualize o painel.");
  }catch(e){
    console.error(e);
    setStatus("Erro","bad");
    alert("‚ùå Falha ao publicar.\n\n" + String(e.message || e));
  }
}

/* ============================
   UPLOAD IMAGEM (cabe√ßalho cidade)
   ============================ */
function renderCabPreview(){
  const prev = $("imgPrev");
  if(!prev) return;
  prev.innerHTML = "";
  const url = ($("fCabUrl").value||"").trim();
  if(!url){
    const d = document.createElement("div");
    d.className = "mini";
    d.style.padding = "10px";
    d.textContent = "Sem imagem definida.";
    prev.appendChild(d);
    return;
  }
  const img = document.createElement("img");
  img.alt = "Pr√©via";
  img.src = url + (url.includes("?") ? "&" : "?") + "ts=" + Date.now();
  prev.appendChild(img);
}

function fileToBase64Plain(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>{
      const dataUrl = String(fr.result || "");
      const comma = dataUrl.indexOf(",");
      if(comma<0) return reject(new Error("Falha ao ler arquivo"));
      resolve(dataUrl.slice(comma+1));
    };
    fr.onerror = ()=>reject(fr.error || new Error("Erro no FileReader"));
    fr.readAsDataURL(file);
  });
}

async function uploadCabImage(){
  const token = getToken();
  if(!token){ alert("Cole seu token e clique em 'Salvar token'."); return; }

  const fi = $("fileCab");
  const file = fi?.files?.[0];
  if(!file){ alert("Selecione uma imagem primeiro."); return; }

  try{
    setStatus("Enviando imagem‚Ä¶","");
    const b64 = await fileToBase64Plain(file);

    const sha = await ghGetShaForPath(token, GITHUB_CAB_PATH);

    await ghPutFileRaw(
      token,
      GITHUB_CAB_PATH,
      b64,
      sha,
      "Atualizar imagem do cabe√ßalho (cidade)"
    );

    $("fCabAtivar").value = "true";
    $("fCabUrl").value = CAB_PUBLIC_URL;

    rebuildJsonView();
    renderCabPreview();
    setStatus("Imagem enviada","ok");

    alert("‚úÖ Imagem enviada!\nAgora clique em PUBLICAR para atualizar o data.json (se necess√°rio).");
  }catch(e){
    console.error(e);
    setStatus("Erro","bad");
    alert("‚ùå Falha ao enviar imagem.\n\n" + String(e.message || e));
  }
}

/* ============================
   ‚úÖ UPLOAD V√çDEO PARA /ads
   ============================ */
function setUploadStatus(msg, type){
  const el = $("uploadStatus");
  if(!el) return;
  el.textContent = msg || "‚Äî";
  el.style.color =
    type==="ok" ? "rgba(68,208,122,.95)" :
    type==="warn" ? "rgba(255,179,71,.95)" :
    type==="bad" ? "rgba(255,90,90,.95)" :
    "rgba(234,242,255,.78)";
}

// ‚úÖ CORRIGIDO: era "aasync"
async function uploadVideoToAds(){
  const token = getToken();
  if(!token){ alert("Cole seu token e clique em 'Salvar token'."); return; }

  const fi = $("adUploadFile");
  const file = fi?.files?.[0];
  if(!file){ alert("Selecione um v√≠deo primeiro."); return; }

  const maxBytes = 50 * 1024 * 1024;
  if (file.size > maxBytes){
    alert("Esse v√≠deo parece grande demais para enviar pelo bot√£o (API do GitHub).\n\n" +
          "Tamanho: " + Math.round(file.size/1024/1024) + " MB\n" +
          "Limite recomendado: at√© 50 MB.\n\n" +
          "Solu√ß√£o: enviar manualmente pelo site do GitHub (Add file ‚Üí Upload) ou reduzir o v√≠deo.");
    return;
  }

  try{
    setUploadStatus("Lendo arquivo‚Ä¶", "warn");
    setStatus("Enviando v√≠deo‚Ä¶","");

    const safeName = "novo.mp4";
    const path = `${GITHUB_ADS_DIR}/${safeName}`;

    const b64 = await fileToBase64Plain(file);

    const approxB64MB = Math.round((b64.length * 3/4) / 1024 / 1024);
    setUploadStatus(`Enviando (aprox ${approxB64MB} MB)‚Ä¶`, "warn");

    const sha = await ghGetShaForPath(token, path);

    await ghPutFileRaw(
      token,
      path,
      b64,
      sha,
      `Upload v√≠deo (ads): ${safeName}`
    );

    ensureBaseShape();
    const rel = `./ads/${safeName}`;

    const exists = DATA.publicidade.videos.some(v => String(v?.arquivo||"") === rel);
    if(!exists){
      DATA.publicidade.videos.push({ arquivo: rel, anunciante: "Novo v√≠deo" });
    }

    renderVideos();
    rebuildJsonView();

    setStatus("V√≠deo enviado","ok");
    setUploadStatus(`‚úÖ Enviado: ${rel}`, "ok");

    fi.value = "";
    alert("‚úÖ V√≠deo enviado para /ads como: " + safeName + "\n\nUse no campo 'arquivo':\n" + rel);
  }catch(e){
    console.error(e);
    setStatus("Erro","bad");
    setUploadStatus("‚ùå Falha no upload: " + String(e.message || e), "bad");
    alert("‚ùå Falha ao enviar v√≠deo.\n\n" + String(e.message || e));
  }
}

/* ============================
   ALERTA: BOT√ïES R√ÅPIDOS
   ============================ */
function alertOn(){
  $("fAlertAtivar").value = "true";
  rebuildJsonView();
  alert("Alerta ligado (ainda falta PUBLICAR).");
}
function alertOff(){
  $("fAlertAtivar").value = "false";
  rebuildJsonView();
  alert("Alerta desligado (ainda falta PUBLICAR).");
}

/* ============================
   BIND UI
   ============================ */
function bind(){
  document.querySelectorAll(".tab").forEach(b=>{
    b.onclick = ()=> setTab(b.dataset.tab);
  });

  $("btnCreatePass").onclick = handleCreatePass;
  $("btnEnterPass").onclick = handleEnterPass;
  $("btnResetPass").onclick = handleResetPass;

  $("btnSaveToken").onclick = saveToken;
  $("btnClearToken").onclick = clearToken;

  $("btnOpenPanel").onclick = ()=>{ window.open("../", "_blank"); };
  $("btnOpenSindico").onclick = ()=>{ window.open("../sindico/", "_blank"); };

  $("btnLoad").onclick = ()=> loadData("manual");

  $("btnDownload").onclick = downloadJson;
  $("btnPublish").onclick = publishToGitHub;

  $("btnChangePass").onclick = handleChangePass;
  $("btnLogout").onclick = logout;

  $("btnRebuild").onclick = rebuildJsonView;
  $("btnCopyJson").onclick = copyJson;

  $("btnBuscarCidade").onclick = buscarCidade;
  $("btnUploadCab").onclick = uploadCabImage;
  $("fCabUrl").addEventListener("input", renderCabPreview);

  $("btnAddAviso").onclick = addAviso;
  $("btnSortAvisos").onclick = sortAvisos;

  $("btnAddVideo").onclick = addVideo;
  $("btnShuffleToggle").onclick = toggleShuffle;

  $("btnUploadToAds").onclick = uploadVideoToAds;

  $("btnAlertOn").onclick = alertOn;
  $("btnAlertOff").onclick = alertOff;

  const liveIds = [
    "fTitulo","fSubtitulo","fReferencia",
    "fRotInterval","fRotQtd",
    "fCidade","fLat","fLon","fTz",
    "fCabAtivar","fCabUrl",
    "fAlertAtivar","fAlertPiscar","fAlertTitulo","fAlertMsg"
  ];
  liveIds.forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("input", rebuildJsonView);
    el.addEventListener("change", rebuildJsonView);
  });

  bindAutoCarregar();

  const r1 = $("rememberToken");
  if(r1){
    r1.addEventListener("click", (e)=> e.stopPropagation());
    r1.addEventListener("change", ()=>{});
  }
}

/* ============================
   INIT
   ============================ */
bind();
initTokenUI();
applyAutoCarregarUI();
setStatus("Offline","bad");
setAutoBadge(false);
setUploadStatus("‚Äî", "");

// ‚úÖ IMPORTANTE: com o AUTH em sessionStorage, VAI PEDIR SENHA sempre que abrir de novo
showLogin(); // sempre pede ao abrir
setTab("tAlerta"); // pode deixar j√° na aba, mas ainda bloqueado pelo overlay

/* ============================
   SERVICE WORKER GLOBAL
   ============================ */
if ("serviceWorker" in navigator) {
  const base = "/comunica-sindico/";
  const swUrl = base + "sw.js";
  window.addEventListener("load", () => {
    navigator.serviceWorker.register(swUrl, { scope: base }).catch(() => {});
  });
}
</script>

